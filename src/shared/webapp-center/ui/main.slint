struct WebAppItem {
    name: string,
    slug: string,
    url: string,
    secure: bool,
    vpn_iface: string,
    vpn_required: bool,
    icon: string,
    marked: bool,
}

export global Theme {
    in-out property <color> bg: #1e1e2e;
    in-out property <color> fg: #cdd6f4;
    in-out property <color> fg_dim: #a6adc8;
    in-out property <color> accent: #89b4fa;
    in-out property <color> bg_light: #45475a;
    in-out property <color> bg_lighter: #585b70;
    in-out property <color> red: #f38ba8;
    in-out property <color> green: #a6e3a1;
    in-out property <color> yellow: #f9e2af;
    in-out property <color> cyan: #94e2d5;
    in-out property <float> opacity: 0.40;
    in-out property <length> card_radius: 6px;
    in-out property <length> button_radius: 4px;
}

// Reusable text input
component FormField inherits Rectangle {
    in property <string> label;
    in-out property <string> value;
    in property <string> placeholder;
    callback edited(string);
    callback accepted();

    height: 58px;
    background: transparent;

    VerticalLayout {
        spacing: 3px;
        padding-left: 2px;

        Text {
            text: root.label;
            color: Theme.fg_dim;
            font-size: 11px;
        }
        Rectangle {
            height: 32px;
            border-radius: Theme.button_radius;
            background: Theme.bg_light;
            border-width: input.has-focus ? 1px : 0px;
            border-color: Theme.accent;

            input := TextInput {
                x: 8px;
                width: parent.width - 16px;
                vertical-alignment: center;
                font-size: 13px;
                color: Theme.fg;
                text <=> root.value;

                accepted => { root.accepted(); }
                edited => {
                    root.edited(root.value);
                }
            }

            if root.value == "": Text {
                x: 8px;
                text: root.placeholder;
                color: Theme.fg_dim;
                font-size: 13px;
                vertical-alignment: center;
                opacity: 0.5;
            }
        }
    }

    public function focus-field() {
        input.focus();
    }
}

// Toggle switch (Tab-focusable, Space/Enter toggles)
component ToggleRow inherits FocusScope {
    in property <string> label;
    in-out property <bool> checked: false;
    callback toggled(bool);

    height: 32px;

    key-pressed(event) => {
        if (root.enabled && (event.text == " " || event.text == Key.Return)) {
            root.checked = !root.checked;
            root.toggled(root.checked);
            return accept;
        }
        return reject;
    }

    HorizontalLayout {
        padding-left: 2px;
        spacing: 8px;

        Text {
            text: root.label;
            color: root.enabled ? Theme.fg : Theme.fg_dim;
            font-size: 13px;
            vertical-alignment: center;
            horizontal-stretch: 1;
            opacity: root.enabled ? 1.0 : 0.5;
        }

        VerticalLayout {
            alignment: center;
            Rectangle {
                width: 40px;
                height: 22px;
                border-radius: 11px;
                background: !root.enabled ? Theme.bg_lighter.transparentize(0.5)
                    : (root.checked ? Theme.accent : Theme.bg_lighter);
                border-width: root.has-focus && root.enabled ? 1px : 0px;
                border-color: Theme.fg;
                opacity: root.enabled ? 1.0 : 0.4;

                Rectangle {
                    x: root.checked ? parent.width - self.width - 3px : 3px;
                    y: (parent.height - self.height) / 2;
                    width: 16px;
                    height: 16px;
                    border-radius: 8px;
                    background: Theme.fg;
                    animate x { duration: 120ms; }
                }

                TouchArea {
                    enabled: root.enabled;
                    clicked => {
                        root.focus();
                        root.checked = !root.checked;
                        root.toggled(root.checked);
                    }
                }
            }
        }
    }
}

// Header button
component HeaderButton inherits Rectangle {
    in property <string> label;
    in property <color> bg-color: Theme.bg_light;
    in property <color> hover-color: Theme.accent;
    callback clicked();

    border-radius: Theme.button_radius;
    background: btn_touch.has-hover ? root.hover-color : root.bg-color;
    min-width: 26px;
    height: 26px;

    HorizontalLayout {
        alignment: center;
        padding-left: 8px;
        padding-right: 8px;
        Text {
            text: root.label;
            color: btn_touch.has-hover ? Theme.bg : Theme.fg;
            font-size: 12px;
            vertical-alignment: center;
        }
    }

    btn_touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

// Main window
export component MainWindow inherits Window {
    width: 440px;
    height: 520px;
    title: "Web Apps";
    no-frame: true;
    background: Theme.bg.transparentize(1.0 - Theme.opacity);
    forward-focus: key_scope;

    in-out property <[WebAppItem]> webapps: [];
    in-out property <int> selected-index: -1;
    in-out property <string> title-text: "Web Apps";
    in-out property <[string]> vpn-interfaces: [];

    // false = list, true = form
    in-out property <bool> show-form: false;
    in-out property <bool> show-about: false;

    in-out property <string> form-name: "";
    in-out property <string> form-url: "";
    in-out property <bool> form-secure: false;
    in-out property <string> form-vpn: "";
    in-out property <bool> form-vpn-required: false;
    in-out property <bool> form-vpn-is-known: false;
    in-out property <string> form-error: "";
    in-out property <int> form-editing-index: -1;

    private property <length> row-height: 42px;
    private property <length> row-spacing: 6px;
    private property <length> row-step: root.row-height + root.row-spacing;

    callback refresh();
    callback delete-app(int);
    callback delete-all();
    callback save-app(string, string, bool, string, bool);
    callback close();
    callback start-drag();
    callback toggle-mark(int);
    callback delete-marked(int);

    public function focus-list() { key_scope.focus(); }

    public function show-create-screen() {
        root.form-name = "";
        root.form-url = "";
        root.form-secure = false;
        root.form-vpn = "";
        root.form-vpn-required = false;
        root.form-vpn-is-known = false;
        root.form-error = "";
        root.form-editing-index = -1;
        root.show-form = true;
        url_field.focus-field();
    }

    public function show-edit-screen(index: int) {
        if (index < 0 || index >= root.webapps.length) { return; }
        root.form-name = root.webapps[index].name;
        root.form-url = root.webapps[index].url;
        root.form-secure = root.webapps[index].secure;
        root.form-vpn = root.webapps[index].vpn-iface;
        root.form-vpn-required = root.webapps[index].vpn-required;
        root.form-vpn-is-known = false;
        root.form-error = "";
        root.form-editing-index = index;
        root.show-form = true;
        url_field.focus-field();
    }

    public function go-back-to-list() {
        root.show-form = false;
        root.form-error = "";
        key_scope.focus();
    }

    function min-viewport-y() -> length {
        return min(0px, list_flick.height - list_flick.viewport-height);
    }

    function clamp-viewport() {
        if (list_flick.viewport-y > 0px) { list_flick.viewport-y = 0px; }
        if (list_flick.viewport-y < root.min-viewport-y()) {
            list_flick.viewport-y = root.min-viewport-y();
        }
    }

    function scroll-by(delta: length) {
        list_flick.viewport-y += delta;
        root.clamp-viewport();
    }

    function min-about-viewport-y() -> length {
        return min(0px, about_flick.height - about_flick.viewport-height);
    }

    function clamp-about-viewport() {
        if (about_flick.viewport-y > 0px) { about_flick.viewport-y = 0px; }
        if (about_flick.viewport-y < root.min-about-viewport-y()) {
            about_flick.viewport-y = root.min-about-viewport-y();
        }
    }

    function scroll-about-by(delta: length) {
        about_flick.viewport-y += delta;
        root.clamp-about-viewport();
    }

    function ensure-selected-visible() {
        if (root.selected-index < 0 || root.selected-index >= root.webapps.length) { return; }
        if (list_flick.viewport-y + root.selected-index * root.row-step < 0px) {
            list_flick.viewport-y = 0px - root.selected-index * root.row-step;
        }
        if (list_flick.viewport-y + root.selected-index * root.row-step + root.row-height > list_flick.height) {
            list_flick.viewport-y = list_flick.height - root.selected-index * root.row-step - root.row-height;
        }
        root.clamp-viewport();
    }

    changed selected-index => { root.ensure-selected-visible(); }

    changed webapps => {
        if (root.webapps.length == 0) {
            root.selected-index = -1;
            list_flick.viewport-y = 0px;
        } else if (root.selected-index < 0) {
            root.selected-index = 0;
        }
        root.clamp-viewport();
        root.ensure-selected-visible();
    }

    key_scope := FocusScope {
        key-pressed(event) => {
            // About screen
            if (root.show-about) {
                if (event.text == Key.Escape || event.text == "?" || event.text == "/") {
                    root.show-about = false;
                    return accept;
                }
                if (event.text == Key.UpArrow) {
                    root.scroll-about-by(40px);
                    return accept;
                }
                if (event.text == Key.DownArrow) {
                    root.scroll-about-by(-40px);
                    return accept;
                }
                return reject;
            }
            if (!root.show-form) {
                if (event.text == Key.UpArrow) {
                    if (root.webapps.length > 0) {
                        if (root.selected-index <= 0) {
                            root.selected-index = 0;
                        } else {
                            root.selected-index -= 1;
                        }
                    }
                    return accept;
                }
                if (event.text == Key.DownArrow) {
                    if (root.webapps.length > 0) {
                        if (root.selected-index < 0) {
                            root.selected-index = 0;
                        } else if (root.selected-index < root.webapps.length - 1) {
                            root.selected-index += 1;
                        }
                    }
                    return accept;
                }
                if (event.text == " ") {
                    if (root.selected-index >= 0 && root.selected-index < root.webapps.length) {
                        root.toggle-mark(root.selected-index);
                        if (root.selected-index < root.webapps.length - 1) {
                            root.selected-index += 1;
                        }
                    }
                    return accept;
                }
                if (event.text == Key.Return) {
                    if (root.selected-index >= 0 && root.selected-index < root.webapps.length) {
                        root.show-edit-screen(root.selected-index);
                    }
                    return accept;
                }
                if (event.text == Key.Delete) {
                    root.delete-marked(root.selected-index);
                    return accept;
                }
                if (event.text == Key.Escape) {
                    root.close();
                    return accept;
                }
                if (event.modifiers.control && (event.text == "a" || event.text == "A")) {
                    root.show-create-screen();
                    return accept;
                }
                if (event.text == "?" || event.text == "/") {
                    root.show-about = !root.show-about;
                    return accept;
                }
                return reject;
            }
            if (root.show-form) {
                if (event.text == Key.Escape) {
                    root.go-back-to-list();
                    return accept;
                }
                if (event.modifiers.control && (event.text == "s" || event.text == "S")) {
                    root.save-app(root.form-name, root.form-url, root.form-secure, root.form-vpn, root.form-vpn-required);
                    return accept;
                }
                return reject;
            }
            return reject;
        }

        Rectangle {
            border-radius: 0px;
            border-width: 1px;
            border-color: Theme.bg_lighter;
            background: Theme.bg;

            Rectangle {
                x: 6px;
                y: 1px;
                width: parent.width - 12px;
                height: parent.height - 2px;

                VerticalLayout {
                    padding: 4px;
                    spacing: 3px;

                    // HEADER
                    Rectangle {
                        height: 38px;
                        background: transparent;

                        HorizontalLayout {
                            padding-right: 8px;
                            spacing: 6px;

                            // Back button (form only)
                            if root.show-form: VerticalLayout {
                                alignment: center;
                                horizontal-stretch: 0;
                                HeaderButton {
                                    label: "<-";
                                    clicked => { root.go-back-to-list(); }
                                }
                            }

                            // Back button (about screen)
                            if root.show-about: VerticalLayout {
                                alignment: center;
                                horizontal-stretch: 0;
                                HeaderButton {
                                    label: "<-";
                                    clicked => {
                                        key_scope.focus();
                                        root.show-about = false;
                                    }
                                }
                            }

                            // Title
                            VerticalLayout {
                                alignment: center;
                                horizontal-stretch: 0;
                                Text {
                                    text: root.show-about
                                        ? ""
                                        : (root.show-form
                                            ? (root.form-editing-index >= 0 ? "Edit Web App" : "Add Web App")
                                            : root.title-text);
                                    color: Theme.fg;
                                    font-weight: 700;
                                    font-size: 15px;
                                    vertical-alignment: center;
                                }
                            }

                            // Draggable spacer
                            Rectangle {
                                horizontal-stretch: 1;
                                background: transparent;
                                TouchArea {
                                    pointer-event(event) => {
                                        if (event.kind == PointerEventKind.down) {
                                            root.start-drag();
                                        }
                                    }
                                    mouse-cursor: move;
                                }
                            }

                            // Add button (list only) - Ctrl+A shortcut, A underlined
                            if !root.show-form && !root.show-about: VerticalLayout {
                                alignment: center;
                                Rectangle {
                                    border-radius: Theme.button_radius;
                                    background: add_touch.has-hover ? Theme.accent : Theme.bg_light;
                                    min-width: 46px;
                                    height: 26px;

                                    HorizontalLayout {
                                        alignment: center;
                                        padding-left: 8px;
                                        padding-right: 8px;
                                        spacing: 0px;

                                        VerticalLayout {
                                            alignment: center;
                                            Text {
                                                text: "+ ";
                                                color: add_touch.has-hover ? Theme.bg : Theme.fg;
                                                font-size: 12px;
                                            }
                                        }
                                        Rectangle {
                                            width: 9px;
                                            height: parent.height;
                                            Text {
                                                text: "A";
                                                color: add_touch.has-hover ? Theme.bg : Theme.fg;
                                                font-size: 12px;
                                                vertical-alignment: center;
                                            }
                                            Rectangle {
                                                y: parent.height / 2 + 7px;
                                                width: 8px;
                                                height: 1px;
                                                background: add_touch.has-hover ? Theme.bg : Theme.fg;
                                            }
                                        }
                                        VerticalLayout {
                                            alignment: center;
                                            Text {
                                                text: "dd";
                                                color: add_touch.has-hover ? Theme.bg : Theme.fg;
                                                font-size: 12px;
                                            }
                                        }
                                    }

                                    add_touch := TouchArea {
                                        clicked => {
                                            key_scope.focus();
                                            root.show-create-screen();
                                        }
                                    }
                                }
                            }

                            // Delete All (list only, when apps exist)
                            if !root.show-form && !root.show-about && root.webapps.length > 0: VerticalLayout {
                                alignment: center;
                                HeaderButton {
                                    label: "Del All";
                                    hover-color: Theme.red;
                                    clicked => {
                                        key_scope.focus();
                                        root.delete-all();
                                    }
                                }
                            }

                            // About button (list only) - next to Close
                            if !root.show-form && !root.show-about: VerticalLayout {
                                alignment: center;
                                Rectangle {
                                    border-radius: Theme.button_radius;
                                    background: about_touch.has-hover ? Theme.accent : Theme.bg_light;
                                    width: 26px;
                                    height: 26px;
                                    Text {
                                        text: "?";
                                        color: about_touch.has-hover ? Theme.bg : Theme.fg;
                                        font-size: 13px;
                                        font-weight: 700;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }
                                    about_touch := TouchArea {
                                        clicked => {
                                            key_scope.focus();
                                            root.show-about = true;
                                        }
                                    }
                                }
                            }

                            // Save button (form only) - Ctrl+S shortcut, S underlined
                            if root.show-form: VerticalLayout {
                                alignment: center;
                                Rectangle {
                                    border-radius: Theme.button_radius;
                                    background: save_touch.has-hover ? Theme.accent : Theme.bg_light;
                                    min-width: 46px;
                                    height: 26px;

                                    HorizontalLayout {
                                        alignment: center;
                                        padding-left: 8px;
                                        padding-right: 8px;
                                        spacing: 0px;

                                        Rectangle {
                                            width: 8px;
                                            height: parent.height;
                                            Text {
                                                text: "S";
                                                color: save_touch.has-hover ? Theme.bg : Theme.fg;
                                                font-size: 12px;
                                                vertical-alignment: center;
                                            }
                                            Rectangle {
                                                y: parent.height / 2 + 7px;
                                                width: 7px;
                                                height: 1px;
                                                background: save_touch.has-hover ? Theme.bg : Theme.fg;
                                            }
                                        }
                                        VerticalLayout {
                                            alignment: center;
                                            Text {
                                                text: "ave";
                                                color: save_touch.has-hover ? Theme.bg : Theme.fg;
                                                font-size: 12px;
                                            }
                                        }
                                    }

                                    save_touch := TouchArea {
                                        clicked => {
                                            root.save-app(root.form-name, root.form-url, root.form-secure, root.form-vpn, root.form-vpn-required);
                                        }
                                    }
                                }
                            }

                            // Close
                            VerticalLayout {
                                alignment: center;
                                Rectangle {
                                    border-radius: Theme.button_radius;
                                    background: close_touch.has-hover ? Theme.red : Theme.bg_light;
                                    width: 26px;
                                    height: 26px;
                                    Text {
                                        text: "x";
                                        color: close_touch.has-hover ? Theme.bg : Theme.fg;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }
                                    close_touch := TouchArea {
                                        clicked => { root.close(); }
                                    }
                                }
                            }
                        }
                    }

                    // CONTENT
                    Rectangle {
                        vertical-stretch: 1;
                        background: transparent;

                        // LIST VIEW (always exists, hidden when form shown)
                        Rectangle {
                            visible: !root.show-form;
                            width: parent.width;
                            height: parent.height;

                            Rectangle {
                                width: parent.width;
                                height: parent.height;
                                clip: true;

                                list_flick := Flickable {
                                    width: parent.width - 14px;
                                    height: parent.height;
                                    viewport-width: self.width;
                                    interactive: true;

                                    VerticalLayout {
                                        alignment: start;
                                        spacing: root.row-spacing;

                                        for app[index] in root.webapps: Rectangle {
                                            border-radius: Theme.card_radius;
                                            background: app.marked
                                                ? (root.selected-index == index
                                                    ? Theme.accent.transparentize(0.6)
                                                    : Theme.accent.transparentize(0.8))
                                                : (root.selected-index == index
                                                    ? Theme.bg_lighter
                                                    : (row_touch.has-hover ? Theme.bg_lighter : Theme.bg_light));

                                            row_touch := TouchArea {
                                                clicked => {
                                                    key_scope.focus();
                                                    root.selected-index = index;
                                                    root.show-edit-screen(index);
                                                }
                                                scroll-event(event) => {
                                                    root.scroll-by(event.delta-y);
                                                    return accept;
                                                }
                                            }

                                            HorizontalLayout {
                                                padding-left: 10px;
                                                padding-right: 6px;
                                                padding-top: 6px;
                                                padding-bottom: 6px;
                                                spacing: 8px;

                                                VerticalLayout {
                                                    alignment: center;
                                                    Text {
                                                        width: 22px;
                                                        text: app.marked ? "v" : "o";
                                                        color: app.marked ? Theme.green : Theme.accent;
                                                        font-size: 16px;
                                                        horizontal-alignment: center;
                                                    }
                                                }

                                                VerticalLayout {
                                                    horizontal-stretch: 1;
                                                    spacing: 1px;
                                                    alignment: center;
                                                    Text {
                                                        text: app.name;
                                                        color: Theme.fg;
                                                        font-weight: 600;
                                                        font-size: 13px;
                                                        overflow: elide;
                                                    }
                                                    Text {
                                                        text: app.url;
                                                        color: Theme.fg_dim;
                                                        font-size: 11px;
                                                        overflow: elide;
                                                    }
                                                }

                                                VerticalLayout {
                                                    alignment: center;
                                                    spacing: 2px;
                                                    if app.secure: Rectangle {
                                                        height: 16px;
                                                        min-width: 16px;
                                                        border-radius: 3px;
                                                        background: Theme.green.transparentize(0.7);
                                                        HorizontalLayout {
                                                            alignment: center;
                                                            Text {
                                                                text: "S";
                                                                color: Theme.green;
                                                                font-size: 9px;
                                                                vertical-alignment: center;
                                                            }
                                                        }
                                                    }
                                                    if app.vpn_iface != "": Rectangle {
                                                        height: 16px;
                                                        min-width: 16px;
                                                        border-radius: 3px;
                                                        background: Theme.cyan.transparentize(0.7);
                                                        HorizontalLayout {
                                                            alignment: center;
                                                            Text {
                                                                text: "V";
                                                                color: Theme.cyan;
                                                                font-size: 9px;
                                                                vertical-alignment: center;
                                                            }
                                                        }
                                                    }
                                                }

                                                VerticalLayout {
                                                    alignment: center;
                                                    Rectangle {
                                                        border-radius: Theme.button_radius;
                                                        background: del_touch.has-hover ? Theme.red : transparent;
                                                        width: 24px;
                                                        height: 24px;
                                                        opacity: row_touch.has-hover || del_touch.has-hover ? 1.0 : 0.4;
                                                        Text {
                                                            text: "x";
                                                            color: del_touch.has-hover ? Theme.bg : Theme.fg_dim;
                                                            font-size: 14px;
                                                            horizontal-alignment: center;
                                                            vertical-alignment: center;
                                                        }
                                                        del_touch := TouchArea {
                                                            clicked => {
                                                                key_scope.focus();
                                                                root.delete-app(index);
                                                            }
                                                            scroll-event(event) => {
                                                                root.scroll-by(event.delta-y);
                                                                return accept;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                Rectangle {
                                    visible: list_flick.viewport-height > list_flick.height;
                                    x: parent.width - 6px;
                                    width: 6px;
                                    height: parent.height;
                                    background: Theme.bg_light;
                                    Rectangle {
                                        width: parent.width;
                                        height: max(24px, parent.height * parent.height / list_flick.viewport-height);
                                        y: list_flick.viewport-height > list_flick.height
                                            ? (-list_flick.viewport-y / (list_flick.viewport-height - list_flick.height)) * (parent.height - self.height)
                                            : 0px;
                                        background: Theme.bg_lighter;
                                        opacity: 0.5;
                                    }
                                }
                            }

                            if root.webapps.length == 0 && !root.show-about: Rectangle {
                                width: parent.width;
                                height: parent.height;
                                background: transparent;
                                VerticalLayout {
                                    alignment: center;
                                    spacing: 12px;
                                    Text {
                                        text: "o";
                                        color: Theme.accent;
                                        font-size: 40px;
                                        horizontal-alignment: center;
                                    }
                                    Text {
                                        text: "No web apps yet";
                                        color: Theme.fg;
                                        font-size: 14px;
                                        horizontal-alignment: center;
                                    }
                                    Text {
                                        text: "Press Ctrl+A or click + Add to create one";
                                        color: Theme.fg_dim;
                                        font-size: 12px;
                                        horizontal-alignment: center;
                                    }
                                }
                            }

                            // ABOUT OVERLAY
                            Rectangle {
                                visible: root.show-about;
                                width: parent.width;
                                height: parent.height;
                                background: Theme.bg;

                                about_flick := Flickable {
                                    width: parent.width;
                                    height: parent.height;
                                    viewport-width: self.width;

                                    VerticalLayout {
                                        padding: 16px;
                                        padding-top: 8px;
                                        spacing: 14px;
                                        alignment: start;

                                        // App name + version
                                        VerticalLayout {
                                            spacing: 4px;
                                            alignment: center;
                                            Text {
                                                text: "Web App Center";
                                                color: Theme.accent;
                                                font-weight: 700;
                                                font-size: 20px;
                                                horizontal-alignment: center;
                                            }
                                            Text {
                                                text: "v0.9";
                                                color: Theme.fg_dim;
                                                font-size: 12px;
                                                horizontal-alignment: center;
                                            }
                                        }

                                        // Description
                                        Text {
                                            text: "Web App Center lets you turn any website into a standalone desktop app with its own launcher, icon, and isolated browser profile.";
                                            color: Theme.fg;
                                            font-size: 13px;
                                            wrap: word-wrap;
                                            horizontal-alignment: center;
                                        }

                                        // How it works
                                        Rectangle {
                                            border-radius: Theme.card_radius;
                                            background: Theme.bg_light;

                                            VerticalLayout {
                                                padding: 12px;
                                                spacing: 8px;

                                                Text {
                                                    text: "How it works";
                                                    color: Theme.accent;
                                                    font-weight: 600;
                                                    font-size: 13px;
                                                }
                                                Text {
                                                    text: "Each web app runs in a bubblewrap (bwrap) sandbox with its own browser profile directory. This means:\n\n- Completely isolated cookies and sessions\n- No cross-site tracking between apps\n- Separate login sessions per app\n- Extensions can be disabled per app (Secure mode)\n- Optional VPN binding per app\n\nApps appear in your application launcher just like native desktop apps, with their own favicon as the icon.";
                                                    color: Theme.fg;
                                                    font-size: 12px;
                                                    wrap: word-wrap;
                                                }
                                            }
                                        }

                                        // Keyboard shortcuts
                                        Rectangle {
                                            border-radius: Theme.card_radius;
                                            background: Theme.bg_light;

                                            VerticalLayout {
                                                padding: 12px;
                                                spacing: 6px;

                                                Text {
                                                    text: "Keyboard shortcuts";
                                                    color: Theme.accent;
                                                    font-weight: 600;
                                                    font-size: 13px;
                                                }
                                                VerticalLayout {
                                                    spacing: 3px;

                                                    HorizontalLayout {
                                                        Text {
                                                            text: "Ctrl+A";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                            width: 72px;
                                                        }
                                                        Text {
                                                            text: "Add new web app";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                        }
                                                    }
                                                    HorizontalLayout {
                                                        Text {
                                                            text: "Ctrl+S";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                            width: 72px;
                                                        }
                                                        Text {
                                                            text: "Save (in form)";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                        }
                                                    }
                                                    HorizontalLayout {
                                                        Text {
                                                            text: "Space";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                            width: 72px;
                                                        }
                                                        Text {
                                                            text: "Mark/unmark app";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                        }
                                                    }
                                                    HorizontalLayout {
                                                        Text {
                                                            text: "Delete";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                            width: 72px;
                                                        }
                                                        Text {
                                                            text: "Delete marked/selected";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                        }
                                                    }
                                                    HorizontalLayout {
                                                        Text {
                                                            text: "Enter";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                            width: 72px;
                                                        }
                                                        Text {
                                                            text: "Edit selected app";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                        }
                                                    }
                                                    HorizontalLayout {
                                                        Text {
                                                            text: "Esc";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                            width: 72px;
                                                        }
                                                        Text {
                                                            text: "Close / go back";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                        }
                                                    }
                                                    HorizontalLayout {
                                                        Text {
                                                            text: "?";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                            width: 72px;
                                                        }
                                                        Text {
                                                            text: "Toggle this screen";
                                                            color: Theme.fg;
                                                            font-size: 12px;
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        // Part of smplOS
                                        Text {
                                            text: "Part of smplOS";
                                            color: Theme.fg_dim;
                                            font-size: 11px;
                                            horizontal-alignment: center;
                                        }

                                        Rectangle { vertical-stretch: 1; }
                                    }
                                }
                            }
                        }

                        // FORM VIEW (always exists, hidden when list shown)
                        Rectangle {
                            visible: root.show-form;
                            width: parent.width;
                            height: parent.height;

                            Flickable {
                                width: parent.width;
                                height: parent.height;
                                viewport-width: self.width;

                                VerticalLayout {
                                    padding: 8px;
                                    padding-top: 4px;
                                    spacing: 6px;

                                    Text {
                                        text: "Each web app runs in a sandboxed browser\nprofile with isolated cookies and data.";
                                        color: Theme.fg_dim;
                                        font-size: 11px;
                                        wrap: word-wrap;
                                    }

                                    url_field := FormField {
                                        label: "URL";
                                        placeholder: "https://example.com";
                                        value <=> root.form-url;
                                        accepted => { name_field.focus-field(); }
                                    }

                                    name_field := FormField {
                                        label: "Name";
                                        placeholder: "My App";
                                        value <=> root.form-name;
                                        accepted => {
                                            root.save-app(root.form-name, root.form-url, root.form-secure, root.form-vpn, root.form-vpn-required);
                                        }
                                    }

                                    ToggleRow {
                                        label: "Secure mode (no extensions)";
                                        checked <=> root.form-secure;
                                    }

                                    vpn_field := FormField {
                                        label: "VPN Interface (optional)";
                                        placeholder: "nordlynx / tun0 / wg0";
                                        value <=> root.form-vpn;
                                        edited(val) => {
                                            if (val == "") {
                                                root.form-vpn-required = false;
                                            }
                                        }
                                    }

                                    ToggleRow {
                                        label: "Require VPN (block without it)";
                                        checked <=> root.form-vpn-required;
                                        enabled: root.form-vpn != "";
                                    }

                                    Text {
                                        visible: root.form-error != "";
                                        text: root.form-error;
                                        color: Theme.red;
                                        font-size: 12px;
                                        wrap: word-wrap;
                                    }

                                    Rectangle { vertical-stretch: 1; }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
