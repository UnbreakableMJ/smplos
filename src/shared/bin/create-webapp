#!/bin/bash
# smplOS: Create a web app launcher with an isolated browser profile
# Usage: create-webapp [--url URL] [--name NAME]
#        create-webapp                  (interactive via terminal)

set -euo pipefail

APPS_DIR="$HOME/.local/share/applications"
ICONS_DIR="$HOME/.local/share/icons/hicolor/256x256/apps"
desktop_file=""

url=""
name=""
vpn_iface_name=""
vpn_required=false

# Detect likely VPN interfaces currently present on the system.
list_vpn_interfaces() {
  command -v ip &>/dev/null || return 0
  ip -o link show 2>/dev/null \
    | awk -F': ' '{print $2}' \
    | sed 's/@.*//' \
    | grep -E '^(tun[0-9]*|tap[0-9]*|wg[0-9]*|ppp[0-9]*|nordlynx|tailscale0|mullvad.*|proton.*|zt[0-9a-z]+)$' \
    | sort -u
}

# Parse args for non-interactive use
while [[ $# -gt 0 ]]; do
  case "$1" in
    --url)
      [[ $# -lt 2 ]] && { echo "Missing value for --url" >&2; exit 1; }
      url="$2"
      shift 2
      ;;
    --name)
      shift
      [[ $# -lt 1 ]] && { echo "Missing value for --name" >&2; exit 1; }
      name="$1"
      shift
      # Support unquoted multi-word names: --name Youtube Awesome
      while [[ $# -gt 0 && "$1" != --* ]]; do
        name+=" $1"
        shift
      done
      ;;
    -h|--help)
      echo "Usage: create-webapp [--url URL] [--name NAME]"
      echo "Creates an isolated web app with its own browser profile."
      exit 0 ;;
    *) shift ;;
  esac
done

# Intro text for interactive use
if [[ -z "$url" || -z "$name" ]]; then
  echo ""
  echo "Welcome to Web App Creator"
  echo "Follow these steps to create an isolated web app launcher."
  echo ""
  echo "Each web app runs in a Bubblewrap (bwrap) sandbox with its own"
  echo "dedicated browser profile. Cookies, session data, cache, and local"
  echo "storage are kept separate from your main browser and from other web apps."
  echo ""
  echo "You can also bind a specific VPN interface to the app, and optionally"
  echo "require that VPN to be active before launch, so traffic always follows"
  echo "your chosen VPN path."
  echo ""
fi

# Interactive prompts if missing
if [[ -z "$url" ]]; then
  if command -v gum &>/dev/null; then
    url=$(gum input --placeholder "https://example.com" --prompt "URL> " --prompt.foreground "#00ff00") || exit 1
  else
    read -rp "URL: " url
  fi
fi

if [[ -z "$name" ]]; then
  # Suggest a name from the domain
  suggested=$(echo "$url" | sed 's|https\?://||; s|/.*||; s|^www\.||; s|\..*||')
  suggested="${suggested^}"  # capitalize first letter
  if command -v gum &>/dev/null; then
    name=$(gum input --placeholder "$suggested" --value "$suggested" --prompt "Name> " --prompt.foreground "#00ff00") || exit 1
  else
    read -rp "Name [$suggested]: " name
    [[ -z "$name" ]] && name="$suggested"
  fi
fi

# Validate
[[ "$url" != http* ]] && url="https://$url"
[[ -z "$name" ]] && { echo "Name cannot be empty" >&2; exit 1; }

# Normalize user-provided text for .desktop key/value fields
name="${name//$'\n'/ }"
name="${name//$'\r'/ }"
url="${url//$'\n'/ }"
url="${url//$'\r'/ }"

mkdir -p "$APPS_DIR"

# Sanitize name for filesystem/profile dir
# - Try transliteration first (handles accented/non-Latin names where possible)
# - Lowercase + collapse non-alnum to '-'
name_ascii="$(printf '%s' "$name" | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || printf '%s' "$name")"
safe_name="$(printf '%s' "$name_ascii" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+//; s/-+$//')"
[[ -z "$safe_name" ]] && safe_name="webapp-$(date +%s)"
desktop_file="$APPS_DIR/${safe_name}.desktop"

# Ask whether to enable secure mode
read -r -p "Enable secure mode (disables extensions)? (y/N) " secure_choice
secure=""
if [[ "$secure_choice" =~ ^[Yy]$ ]]; then
  secure="--secure"
fi

# Ask for VPN configuration
detected_vpns=()
while IFS= read -r iface; do
  [[ -n "$iface" ]] && detected_vpns+=("$iface")
done < <(list_vpn_interfaces)

if command -v gum &>/dev/null; then
  if [[ ${#detected_vpns[@]} -gt 0 ]]; then
    vpn_choice=$(printf '%s\n' "None" "${detected_vpns[@]}" "Custom..." \
      | gum choose --header "Route traffic through VPN interface?") || exit 1
  else
    vpn_choice=$(printf '%s\n' "None" "Custom..." \
      | gum choose --header "Route traffic through VPN interface?") || exit 1
  fi

  case "$vpn_choice" in
    "None"|"")
      vpn_iface_name=""
      ;;
    "Custom...")
      vpn_iface_name=$(gum input --placeholder "nordlynx / tun0 / wg0" --prompt "VPN iface> " --prompt.foreground "#00ff00") || exit 1
      ;;
    *)
      vpn_iface_name="$vpn_choice"
      ;;
  esac
else
  vpn_hint=""
  if [[ ${#detected_vpns[@]} -gt 0 ]]; then
    vpn_hint="Detected: ${detected_vpns[*]}"
  fi
  read -r -p "Route through a VPN interface? (e.g., nordlynx, tun0) [optional] ${vpn_hint:+[$vpn_hint]}: " vpn_iface_name
fi

if [[ -n "$vpn_iface_name" ]]; then
  read -r -p "Is this VPN connection REQUIRED? (App will not launch without it) (y/N): " vpn_required_choice
  if [[ "$vpn_required_choice" =~ ^[Yy]$ ]]; then
    vpn_required=true
  fi
fi

# Escape for .desktop key=value fields (not Exec)
desktop_escape_kv() {
  local s="$1"
  s="${s//\\/\\\\}"
  s="${s//$'\t'/ }"
  s="${s//$'\n'/ }"
  s="${s//$'\r'/ }"
  printf '%s' "$s"
}

# Quote one Exec argument for .desktop Exec= format
desktop_quote_exec_arg() {
  local s="$1"
  s="${s//\\/\\\\}"
  s="${s//\"/\\\"}"
  printf '"%s"' "$s"
}


# Find a suitable icon
# 1. Try to fetch favicon
icon_path=""
mkdir -p "$ICONS_DIR"
domain=$(echo "$url" | sed 's|https\?://||; s|/.*||')
favicon_url="https://www.google.com/s2/favicons?domain=${domain}&sz=256"
icon_file="$ICONS_DIR/webapp-${safe_name}.png"
if curl -sL --max-time 5 "$favicon_url" -o "$icon_file" 2>/dev/null && [[ -s "$icon_file" ]]; then
  icon_path="webapp-${safe_name}"
else
  rm -f "$icon_file"
  icon_path="applications-internet"  # fallback generic icon
fi

# Create the .desktop file
exec_line="launch-webapp"
[[ -n "$secure" ]] && exec_line+=" $(desktop_quote_exec_arg --secure)"
if [[ -n "$vpn_iface_name" ]]; then
  exec_line+=" $(desktop_quote_exec_arg --vpn-interface)"
  exec_line+=" $(desktop_quote_exec_arg "$vpn_iface_name")"
  $vpn_required && exec_line+=" $(desktop_quote_exec_arg --vpn-required)"
fi
exec_line+=" $(desktop_quote_exec_arg --name)"
exec_line+=" $(desktop_quote_exec_arg "$safe_name")"
exec_line+=" $(desktop_quote_exec_arg "$url")"

desktop_name="$(desktop_escape_kv "$name")"
desktop_comment="$(desktop_escape_kv "Web app for $url")"

cat > "$desktop_file" << EOF
[Desktop Entry]
Version=1.0
Type=Application
Name=$desktop_name
Comment=$desktop_comment
Exec=$exec_line
Icon=$icon_path
StartupWMClass=brave-$safe_name
Terminal=false
Categories=Network;WebBrowser;
EOF

# Make it executable
chmod +x "$desktop_file"

# Update desktop database so it appears in launchers
update-desktop-database "$APPS_DIR" 2>/dev/null || true

echo "Created: $name -> $url"
echo "Profile: ~/.local/share/webapps/$safe_name/"
echo "Launcher: $desktop_file"

# Rebuild app cache if available (so it shows in our launcher immediately)
command -v rebuild-app-cache &>/dev/null && rebuild-app-cache 2>/dev/null &
