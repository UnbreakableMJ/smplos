#!/bin/bash
# smplOS Theme Background Cycler
# Cycles through wallpapers in the current theme
# Wayland: swaybg | X11: feh

THEME_NAME=$(cat "$HOME/.config/smplos/current/theme.name" 2>/dev/null)
THEME_BACKGROUNDS="$HOME/.config/smplos/current/theme/backgrounds/"
USER_BACKGROUNDS="$HOME/.config/smplos/backgrounds/$THEME_NAME/"
FALLBACK_BACKGROUNDS="$HOME/Pictures/Wallpapers/"
CURRENT_BG_LINK="$HOME/.config/smplos/current/background"

set_wallpaper() {
  if [[ -n "${WAYLAND_DISPLAY:-}" ]]; then
    pkill swaybg 2>/dev/null
    sleep 0.1
    setsid swaybg "$@" &>/dev/null &
  elif [[ -n "${DISPLAY:-}" ]]; then
    case "$1" in
      -c) feh --bg-fill --image-bg "$2" /dev/null 2>/dev/null || xsetroot -solid "$2" 2>/dev/null ;;
      -i) feh --bg-fill "$2" 2>/dev/null ;;
    esac
  fi
  # No display (install/chroot) — skip wallpaper silently
}

# Gather background images — theme-specific dirs only, fallback only if empty
_bg_dirs=()
[[ -d "$USER_BACKGROUNDS" ]] && _bg_dirs+=("$USER_BACKGROUNDS")
[[ -d "$THEME_BACKGROUNDS" ]] && _bg_dirs+=("$THEME_BACKGROUNDS")

mapfile -d '' -t BACKGROUNDS < <(
  [[ ${#_bg_dirs[@]} -gt 0 ]] && find -L "${_bg_dirs[@]}" -maxdepth 1 -type f \( -name '*.jpg' -o -name '*.png' -o -name '*.jpeg' -o -name '*.webp' \) -print0 2>/dev/null | sort -z -u
)

# Only fall back to ~/Pictures/Wallpapers if the theme has no backgrounds at all
if [[ ${#BACKGROUNDS[@]} -eq 0 && -d "$FALLBACK_BACKGROUNDS" ]]; then
  mapfile -d '' -t BACKGROUNDS < <(find -L "$FALLBACK_BACKGROUNDS" -maxdepth 1 -type f \( -name '*.jpg' -o -name '*.png' -o -name '*.jpeg' -o -name '*.webp' \) -print0 2>/dev/null | sort -z -u)
fi

if [[ ${#BACKGROUNDS[@]} -eq 0 ]]; then
  # No backgrounds - use solid color from theme
  bg_color=$(grep '^background' "$HOME/.config/smplos/current/theme/colors.toml" 2>/dev/null | head -1 | sed 's/.*"\(#[^"]*\)".*/\1/')
  set_wallpaper -c "${bg_color:-#0a0a0a}"
  exit 0
fi

# Pick a random background (avoid repeating the current one)
current_name=$(basename "$(readlink "$CURRENT_BG_LINK" 2>/dev/null)" 2>/dev/null)
if [[ ${#BACKGROUNDS[@]} -le 1 ]]; then
  next_index=0
else
  while true; do
    next_index=$(( RANDOM % ${#BACKGROUNDS[@]} ))
    [[ "$(basename "${BACKGROUNDS[$next_index]}")" != "$current_name" ]] && break
  done
fi

# Update symlink
mkdir -p "$(dirname "$CURRENT_BG_LINK")"
ln -snf "${BACKGROUNDS[$next_index]}" "$CURRENT_BG_LINK"

# Set wallpaper
set_wallpaper -i "$CURRENT_BG_LINK" -m fill
