#!/bin/bash
# smplOS Theme Switcher
# Sets the active theme and regenerates all configs
# Usage: theme-set <theme-name>

if [[ -z $1 ]]; then
  echo "Usage: theme-set <theme-name>"
  exit 1
fi

SMPLOS_PATH="${SMPLOS_PATH:-$HOME/.local/share/smplos}"
CURRENT_THEME_PATH="$HOME/.config/smplos/current/theme"
NEXT_THEME_PATH="$HOME/.config/smplos/current/next-theme"
USER_THEMES_PATH="$HOME/.config/smplos/themes"
STOCK_THEMES_PATH="$SMPLOS_PATH/themes"

# Normalize theme name: strip markup, lowercase, spaces to hyphens
THEME_NAME=$(echo "$1" | sed -E 's/<[^>]+>//g' | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

# Resolve theme path (user themes take precedence)
if [[ -d "$USER_THEMES_PATH/$THEME_NAME" ]]; then
  THEME_PATH="$USER_THEMES_PATH/$THEME_NAME"
elif [[ -d "$STOCK_THEMES_PATH/$THEME_NAME" ]]; then
  THEME_PATH="$STOCK_THEMES_PATH/$THEME_NAME"
else
  echo "Theme '$THEME_NAME' does not exist"
  exit 1
fi

# Setup clean next-theme directory (atomic swap)
rm -rf "$NEXT_THEME_PATH"
mkdir -p "$NEXT_THEME_PATH"

# Copy all theme files (colors, configs, backgrounds, etc.)
# Each theme ships pre-baked configs — no template expansion needed
cp -r "$THEME_PATH/"* "$NEXT_THEME_PATH/" 2>/dev/null

# Atomic swap: next-theme -> current theme
rm -rf "$CURRENT_THEME_PATH"
mv "$NEXT_THEME_PATH" "$CURRENT_THEME_PATH"

# Store theme name for reference
echo "$THEME_NAME" > "$HOME/.config/smplos/current/theme.name"

# Link EWW theme colors into EWW config dir
if [[ -f "$CURRENT_THEME_PATH/eww-colors.scss" ]]; then
  mkdir -p "$HOME/.config/eww"
  cp "$CURRENT_THEME_PATH/eww-colors.scss" "$HOME/.config/eww/theme-colors.scss"
fi

# Bake theme colors into SVG icon templates
# Templates in icons/status/ have {{accent}} and {{fg-dim}} placeholders
# We re-copy from source and replace with actual hex values each theme switch
_accent=$(grep '^accent' "$CURRENT_THEME_PATH/colors.toml" 2>/dev/null | head -1 | sed 's/.*"\(#[^"]*\)".*/\1/')
_fg=$(grep '^foreground' "$CURRENT_THEME_PATH/colors.toml" 2>/dev/null | head -1 | sed 's/.*"\(#[^"]*\)".*/\1/')
_bg=$(grep '^background' "$CURRENT_THEME_PATH/colors.toml" 2>/dev/null | head -1 | sed 's/.*"\(#[^"]*\)".*/\1/')
_fg=${_fg:-#888888}
_accent=${_accent:-#888888}
_bg=${_bg:-#1e1e2e}
EWW_ICONS_TPL="$HOME/.local/share/smplos/icons/status"
EWW_ICONS_DST="$HOME/.config/eww/icons/status"
if [[ -d "$EWW_ICONS_TPL" ]]; then
  mkdir -p "$EWW_ICONS_DST"
  for svg in "$EWW_ICONS_TPL"/*.svg; do
    [[ -f "$svg" ]] || continue
    sed "s/{{accent}}/$_accent/g; s/{{fg}}/$_fg/g; s/{{bg}}/$_bg/g" "$svg" > "$EWW_ICONS_DST/$(basename "$svg")"
  done
fi

# Compositor-specific theme configs
# Always copy if the files exist -- during install (chroot) there's no
# WAYLAND_DISPLAY yet, but the configs must be in place for first boot.
if [[ -f "$CURRENT_THEME_PATH/hyprland.conf" ]]; then
  mkdir -p "$HOME/.config/hypr"
  cp "$CURRENT_THEME_PATH/hyprland.conf" "$HOME/.config/hypr/theme.conf"
fi
if [[ -f "$CURRENT_THEME_PATH/hyprlock.conf" ]]; then
  mkdir -p "$HOME/.config/hypr"
  cp "$CURRENT_THEME_PATH/hyprlock.conf" "$HOME/.config/hypr/hyprlock-theme.conf"
fi

# Link dunst theme (concatenate core + theme colors)
if [[ -f "$CURRENT_THEME_PATH/dunstrc.theme" ]]; then
  mkdir -p "$HOME/.config/dunst"
  if [[ -f "$HOME/.config/dunst/dunstrc" ]]; then
    cat "$HOME/.config/dunst/dunstrc" "$CURRENT_THEME_PATH/dunstrc.theme" > "$HOME/.config/dunst/dunstrc.active"
  else
    cp "$CURRENT_THEME_PATH/dunstrc.theme" "$HOME/.config/dunst/dunstrc.active"
  fi
fi

# Link foot theme
if [[ -f "$CURRENT_THEME_PATH/foot.ini" ]]; then
  mkdir -p "$HOME/.config/foot"
  cp "$CURRENT_THEME_PATH/foot.ini" "$HOME/.config/foot/theme.ini"
fi

# Link rofi theme (single file used by launcher + all dialogs)
mkdir -p "$HOME/.config/rofi"
if [[ -f "$CURRENT_THEME_PATH/smplos-launcher.rasi" ]]; then
  cp "$CURRENT_THEME_PATH/smplos-launcher.rasi" "$HOME/.config/rofi/smplos-launcher.rasi"
fi

# st (suckless terminal) -- colors applied at runtime via OSC escape sequences
# No config file copy needed; theme-set-st reads colors.toml directly

# Link btop theme
if [[ -f "$CURRENT_THEME_PATH/btop.theme" ]]; then
  mkdir -p "$HOME/.config/btop/themes"
  cp "$CURRENT_THEME_PATH/btop.theme" "$HOME/.config/btop/themes/current.theme"
fi

# Link fish theme colors
if [[ -f "$CURRENT_THEME_PATH/fish.theme" ]]; then
  mkdir -p "$HOME/.config/fish"
  cp "$CURRENT_THEME_PATH/fish.theme" "$HOME/.config/fish/theme.fish"
fi

# Apply Tide prompt theme (set universal variables so Tide picks them up immediately)
if [[ -f "$CURRENT_THEME_PATH/tide.theme" ]] && command -v fish &>/dev/null; then
  fish -c "source '$CURRENT_THEME_PATH/tide.theme'; tide reload" &>/dev/null || true
fi

# Set wallpaper from theme backgrounds
theme-bg-next

# =========================================================================
# RESTART COMPONENTS — apply new theme live
# All guarded: only runs if the app is actually present/running
# =========================================================================

# EWW bar (kill + restart so new SCSS is compiled)
if pgrep -x eww >/dev/null; then
  eww --config "$HOME/.config/eww" kill 2>/dev/null
  sleep 0.3
  killall -9 eww 2>/dev/null  # ensure no zombies
  # Kill orphaned listener scripts — eww kill only stops the daemon,
  # deflisten child processes get reparented to PID 1 and leak
  pkill -f "scripts/(volume|network|bluetooth|notification|brightness|workspaces|active-workspace|window-title|sysmenu|notif-hub)-?listener?\.sh" 2>/dev/null
  pkill -f "scripts/(workspaces|active-workspace|window-title)\.sh" 2>/dev/null
  sleep 0.2
  bar-ctl start &
fi

# Hyprland (reload config to pick up new border colors -- runtime only)
if [[ -n "${WAYLAND_DISPLAY:-}" ]] && command -v hyprctl &>/dev/null; then
  hyprctl reload 2>/dev/null
fi

# st / st-wl -- apply colors via OSC escape sequences to all running instances
theme-set-st 2>/dev/null &

# Double Commander — regenerate colors.json from theme palette
theme-set-dc 2>/dev/null &

# Foot terminal — reload via SIGUSR1 (if running)
if pgrep -x foot >/dev/null; then
  killall -SIGUSR1 foot 2>/dev/null
fi

# Dunst notification daemon
if pgrep -x dunst >/dev/null; then
  dunstctl reload 2>/dev/null
fi

# btop — SIGUSR2 triggers config reload
if pgrep -x btop >/dev/null; then
  killall -USR2 btop 2>/dev/null
fi

# =========================================================================
# APP-SPECIFIC THEMES — optional integrations
# =========================================================================

# GTK / Icon theme + cursor
if [[ -f "$CURRENT_THEME_PATH/light.mode" ]]; then
  _gtk_theme="Adwaita"
  _color_scheme="prefer-light"
  _dark_pref=0
  _gtk_env="Adwaita"
  _cursor_theme="Breeze_Light"
else
  _gtk_theme="Adwaita-dark"
  _color_scheme="prefer-dark"
  _dark_pref=1
  _gtk_env="Adwaita:dark"
  _cursor_theme="breeze_cursors"
fi

# dconf/GSettings (primary on Wayland — GTK3/4 read from here)
if command -v gsettings &>/dev/null; then
  gsettings set org.gnome.desktop.interface color-scheme "$_color_scheme" 2>/dev/null
  gsettings set org.gnome.desktop.interface gtk-theme "$_gtk_theme" 2>/dev/null
  gsettings set org.gnome.desktop.interface cursor-theme "$_cursor_theme" 2>/dev/null
  if [[ -f "$CURRENT_THEME_PATH/icons.theme" ]]; then
    gsettings set org.gnome.desktop.interface icon-theme "$(<"$CURRENT_THEME_PATH/icons.theme")" 2>/dev/null
  fi
fi

# Set cursor theme for Hyprland + env
export XCURSOR_THEME="$_cursor_theme"
if command -v hyprctl &>/dev/null && [[ -n "${WAYLAND_DISPLAY:-}" ]]; then
  hyprctl setcursor "$_cursor_theme" 24 2>/dev/null || true
fi

# settings.ini (fallback for X11 and apps that don't use dconf)
# Always gtk-theme-name=Adwaita — the "Adwaita-dark" theme doesn't exist as an
# installed theme. Dark variant is activated by gtk-application-prefer-dark-theme
# (settings.ini) and color-scheme (dconf). The gsettings gtk-theme key can hold
# "Adwaita-dark" because GTK's GSettings codepath special-cases it, but the
# settings.ini parser does not.
for _gtk_dir in "$HOME/.config/gtk-3.0" "$HOME/.config/gtk-4.0"; do
  mkdir -p "$_gtk_dir"
  cat > "$_gtk_dir/settings.ini" << EOF
[Settings]
gtk-theme-name=Adwaita
gtk-application-prefer-dark-theme=$_dark_pref
gtk-icon-theme-name=Adwaita
gtk-font-name=JetBrains Mono 11
gtk-cursor-theme-name=$_cursor_theme
EOF
done

# GTK_THEME env var — forces GTK file dialogs (xdg-desktop-portal-gtk) dark/light.
# gsettings alone is unreliable on non-GNOME desktops; this is the direct override.
export GTK_THEME="$_gtk_env"
# Persist for systemd user services (portals start before Hyprland env import)
mkdir -p "$HOME/.config/environment.d"
printf 'GTK_THEME=%s\nXCURSOR_THEME=%s\n' "$_gtk_env" "$_cursor_theme" > "$HOME/.config/environment.d/gtk.conf"
# Push to Hyprland + systemd so portal services see the change without reboot
command -v hyprctl &>/dev/null && hyprctl setenv GTK_THEME "$GTK_THEME" 2>/dev/null || true
command -v hyprctl &>/dev/null && hyprctl setenv XCURSOR_THEME "$_cursor_theme" 2>/dev/null || true
systemctl --user import-environment GTK_THEME XCURSOR_THEME 2>/dev/null || true
# Restart portal-gtk so it picks up the new GTK_THEME
systemctl --user restart xdg-desktop-portal-gtk 2>/dev/null || true

# Neovim — deploy lazy.nvim colorscheme spec
if [[ -f "$CURRENT_THEME_PATH/neovim.lua" ]]; then
  mkdir -p "$HOME/.config/nvim/lua/plugins"
  cp "$CURRENT_THEME_PATH/neovim.lua" "$HOME/.config/nvim/lua/plugins/colorscheme.lua"
fi

# VS Code / Codium / Cursor — set workbench.colorTheme
if [[ -f "$CURRENT_THEME_PATH/vscode.json" ]]; then
  _set_vscode_theme() {
    local cmd="$1" settings="$2"
    command -v "$cmd" &>/dev/null || return 0

    local theme_name extension
    theme_name=$(jq -r '.name' "$CURRENT_THEME_PATH/vscode.json")
    extension=$(jq -r '.extension // empty' "$CURRENT_THEME_PATH/vscode.json")

    # Install extension if needed
    if [[ -n "$extension" ]] && ! "$cmd" --list-extensions 2>/dev/null | grep -Fxq "$extension"; then
      "$cmd" --install-extension "$extension" >/dev/null 2>&1 || true
    fi

    # Update settings.json
    mkdir -p "$(dirname "$settings")"
    [[ -f "$settings" ]] || printf '{\n}\n' > "$settings"

    if ! grep -q '"workbench.colorTheme"' "$settings"; then
      sed -i -E '0,/\{/{s/\{/{ "workbench.colorTheme": "",/}' "$settings"
    fi
    sed -i -E "s/(\"workbench.colorTheme\"[[:space:]]*:[[:space:]]*\")[^\"]*(\")/\1$theme_name\2/" "$settings"
  }

  _set_vscode_theme "code" "$HOME/.config/Code/User/settings.json"
  _set_vscode_theme "codium" "$HOME/.config/VSCodium/User/settings.json"
  _set_vscode_theme "cursor" "$HOME/.config/Cursor/User/settings.json"
fi

# Logseq — switch theme via preferences.json (Logseq watches this file)
# Theme plugins are pre-installed in ~/.logseq/plugins/
_logseq_prefs="$HOME/.logseq/preferences.json"
if [[ -d "$HOME/.logseq/plugins" ]]; then
  _lp="$HOME/.logseq/plugins"

  # Detect dark vs light from marker file
  _lq_mode=dark
  [[ -f "$CURRENT_THEME_PATH/light.mode" ]] && _lq_mode=light

  # Map smplOS theme names to Logseq plugin themes
  # URL must be assets:// + absolute path to the CSS file inside the plugin dir
  _lq_name="" _lq_css="" _lq_pid=""
  case "$THEME_NAME" in
    catppuccin)       _lq_name="Catppuccin Mocha"          _lq_css="$_lp/logseq-catppuccin/ctp-mocha.css"              _lq_pid=logseq-catppuccin ;;
    catppuccin-latte) _lq_name="Catppuccin Latte"          _lq_css="$_lp/logseq-catppuccin/ctp-latte.css"              _lq_pid=logseq-catppuccin ;;
    tokyo-night)      _lq_name="Tokyo Night"               _lq_css="$_lp/tokyo-night/tokyo.css"                        _lq_pid=tokyo-night ;;
    everforest)       _lq_name="Everforest Dark Medium"    _lq_css="$_lp/logseq-everforest-theme/everforest-dark-medium.css" _lq_pid=logseq-everforest-theme ;;
    rose-pine)        _lq_name="Rosé Pine Dawn"            _lq_css="$_lp/logseq-rose-pine-theme/src/rose-pine-dawn.css" _lq_pid=logseq-rose-pine-theme ;;
    flexoki-light)    _lq_name="Flexoki Light"             _lq_css="$_lp/logseq-flexoki-theme/flexoki-theme.css"        _lq_pid=logseq-flexoki-theme ;;
    hackerman)        _lq_name="Matrix AMOLED Dark"        _lq_css="$_lp/logseq-matrixamoled-theme/matrix.css"          _lq_pid=logseq-matrixamoled-theme ;;
    matte-black)      _lq_name="D42ker Logseq"             _lq_css="$_lp/logseq-d42ker-theme/custom.css"               _lq_pid=logseq-d42ker-theme ;;
    gruvbox)          _lq_name="Everforest Dark Soft"      _lq_css="$_lp/logseq-everforest-theme/everforest-dark-soft.css" _lq_pid=logseq-everforest-theme ;;
    kanagawa)         _lq_name="Rosé Pine"                 _lq_css="$_lp/logseq-rose-pine-theme/src/rose-pine.css"      _lq_pid=logseq-rose-pine-theme ;;
    nord)             _lq_name="Rosé Pine Moon"            _lq_css="$_lp/logseq-rose-pine-theme/src/rose-pine-moon.css" _lq_pid=logseq-rose-pine-theme ;;
    osaka-jade)       _lq_name="Everforest Dark Hard"      _lq_css="$_lp/logseq-everforest-theme/everforest-dark-hard.css" _lq_pid=logseq-everforest-theme ;;
    ristretto)        _lq_name="Catppuccin Macchiato"      _lq_css="$_lp/logseq-catppuccin/ctp-macchiato.css"           _lq_pid=logseq-catppuccin ;;
    ethereal)         _lq_name="Catppuccin Mocha"          _lq_css="$_lp/logseq-catppuccin/ctp-mocha.css"              _lq_pid=logseq-catppuccin ;;
  esac

  if [[ -n "$_lq_pid" ]]; then
    # Write preferences.json with plugin theme + correct dark/light mode
    cat > "$_logseq_prefs" <<EOF
{
  "theme": {
    "name": "$_lq_name",
    "url": "assets://$_lq_css",
    "mode": "$_lq_mode",
    "pid": "$_lq_pid"
  },
  "themes": {
    "mode": "$_lq_mode"
  },
  "externals": []
}
EOF
  else
    # No plugin for this theme — just set dark/light mode, clear plugin theme
    cat > "$_logseq_prefs" <<EOF
{
  "themes": {
    "mode": "$_lq_mode"
  },
  "externals": []
}
EOF
  fi

  # Also write custom.css for themes without a plugin (gruvbox, kanagawa, nord, etc.)
  if [[ -f "$CURRENT_THEME_PATH/logseq-custom.css" ]]; then
    cp "$CURRENT_THEME_PATH/logseq-custom.css" "$HOME/.logseq/custom.css"
  fi
fi

# Chromium / Brave -- set browser toolbar color and dark/light mode
# Derives color from colors.toml background (no separate chromium.theme file needed)
BROWSER_BG=$(grep '^background' "$CURRENT_THEME_PATH/colors.toml" 2>/dev/null | head -1 | sed 's/.*"\(#[^"]*\)".*/\1/')
if [[ -n "$BROWSER_BG" ]]; then
  # Determine dark/light mode
  if [[ -f "$CURRENT_THEME_PATH/light.mode" ]]; then
    DARK_MODE=false
  else
    DARK_MODE=true
  fi

  # Build managed policy with dark mode preference
  BROWSER_POLICY=$(printf '{"BrowserThemeColor":"%s","BackgroundModeEnabled":false}' "$BROWSER_BG")

  # Write browser policies (requires root -- skip silently if not root;
  # dev-apply.sh handles this separately since theme-set runs as user)
  if [[ $EUID -eq 0 ]]; then
    for browser in chromium brave; do
      command -v "$browser" &>/dev/null || continue
      mkdir -p "/etc/$browser/policies/managed" 2>/dev/null
      echo "$BROWSER_POLICY" > "/etc/$browser/policies/managed/color.json" 2>/dev/null
    done
  fi

  # Brave/Chromium flags files -- the launcher scripts read these on every start.
  # --force-dark-mode controls the browser UI chrome (title bar, tabs, menus).
  # --enable-features=WebUIDarkMode controls internal pages (settings, etc.).
  _set_browser_dark_flag() {
    local flags_file="$1"
    mkdir -p "$(dirname "$flags_file")"
    touch "$flags_file"
    # Remove any existing dark mode flags
    sed -i '/^--force-dark-mode$/d; /^--enable-features=.*WebUIDarkMode/d' "$flags_file"
    if $DARK_MODE; then
      echo "--force-dark-mode" >> "$flags_file"
      # Add WebUIDarkMode to existing --enable-features or as new line
      if grep -q '^--enable-features=' "$flags_file"; then
        sed -i 's/^--enable-features=\(.*\)/--enable-features=\1,WebUIDarkMode/' "$flags_file"
      else
        echo "--enable-features=WebUIDarkMode" >> "$flags_file"
      fi
    fi
    # Clean up empty lines
    sed -i '/^$/d' "$flags_file"
  }
  _set_browser_dark_flag "$HOME/.config/brave-flags.conf"
  _set_browser_dark_flag "$HOME/.config/chromium-flags.conf"
fi

echo "Theme set to: $THEME_NAME"
