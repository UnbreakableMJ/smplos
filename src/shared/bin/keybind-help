#!/bin/bash
# smplOS Keybinding Help -- searchable keybinding reference via rofi
# Parses bindings.conf with caching for instant display.

CONF="$HOME/.config/smplos/bindings.conf"
[[ -f "$CONF" ]] || CONF="$HOME/.config/hypr/bindings.conf"
[[ -f "$CONF" ]] || { notify-send "Keybind Help" "No bindings.conf found"; exit 1; }

CACHE="/tmp/smplos-keybinds.cache"

# Rebuild cache only when bindings.conf changes
if [[ ! -f "$CACHE" ]] || [[ "$CONF" -nt "$CACHE" ]]; then
  awk -F, '
  /^# ===/ { next }
  /^# [A-Z][A-Z ]/ {
    sub(/^# */, "")
    gsub(/[[:space:]]+$/, "")
    section = $0
    next
  }
  /^bind[a-z]*d[[:space:]]*=/ {
    sub(/^bind[a-z]*d[[:space:]]*=[[:space:]]*/, "")

    mods = $1; key = $2; desc = $3
    gsub(/^[[:space:]]+|[[:space:]]+$/, "", mods)
    gsub(/^[[:space:]]+|[[:space:]]+$/, "", key)
    gsub(/^[[:space:]]+|[[:space:]]+$/, "", desc)

    gsub(/ /, "+", mods); gsub(/^\+|\+$/, "", mods)
    combo = (mods != "" && key != "") ? mods "+" key : (mods != "" ? mods : key)

    # Friendly names
    gsub(/SUPER/, "Super", combo); gsub(/SHIFT/, "Shift", combo)
    gsub(/CTRL/, "Ctrl", combo); gsub(/ALT/, "Alt", combo)
    gsub(/RETURN/, "Enter", combo); gsub(/SPACE/, "Space", combo)
    gsub(/ESCAPE/, "Esc", combo); gsub(/PRINT/, "Print", combo)
    gsub(/LEFT/, "Left", combo); gsub(/RIGHT/, "Right", combo)
    gsub(/UP/, "Up", combo); gsub(/DOWN/, "Down", combo)
    gsub(/BACKSPACE/, "Backspace", combo); gsub(/BackSpace/, "Backspace", combo)
    gsub(/DELETE/, "Delete", combo); gsub(/COMMA/, ",", combo)
    gsub(/TAB/, "Tab", combo)
    gsub(/code:10/, "1", combo); gsub(/code:11/, "2", combo)
    gsub(/code:12/, "3", combo); gsub(/code:13/, "4", combo)
    gsub(/code:14/, "5", combo); gsub(/code:15/, "6", combo)
    gsub(/code:16/, "7", combo); gsub(/code:17/, "8", combo)
    gsub(/code:18/, "9", combo); gsub(/code:19/, "0", combo)
    gsub(/code:20/, "-", combo); gsub(/code:21/, "=", combo)
    gsub(/XF86AudioRaiseVolume/, "Vol Up", combo)
    gsub(/XF86AudioLowerVolume/, "Vol Down", combo)
    gsub(/XF86AudioMute/, "Mute", combo)
    gsub(/XF86AudioMicMute/, "Mic Mute", combo)
    gsub(/XF86MonBrightnessUp/, "Bright Up", combo)
    gsub(/XF86MonBrightnessDown/, "Bright Down", combo)
    gsub(/XF86AudioPlay/, "Play", combo); gsub(/XF86AudioPause/, "Pause", combo)
    gsub(/XF86AudioNext/, "Next Track", combo); gsub(/XF86AudioPrev/, "Prev Track", combo)
    gsub(/mouse_down/, "Scroll Down", combo); gsub(/mouse_up/, "Scroll Up", combo)
    gsub(/mouse:272/, "LMB", combo); gsub(/mouse:273/, "RMB", combo)

    # Print section header if new category
    if (section != "" && section != last_section) {
      if (NR > 1) print ""
      printf "--- %s ---\n", section
      last_section = section
    }
    printf "%-28s %s\n", combo, desc
  }
  ' "$CONF" > "$CACHE"
fi

[[ -s "$CACHE" ]] || { notify-send "Keybind Help" "No keybindings found"; exit 1; }

# Show in rofi (read-only display, no action on selection)
# -normal-window makes it an XDG toplevel so Hyprland applies popin animation
# (layer surfaces all share namespace "rofi" = launcher's slide-left)
ROFI_THEME="$HOME/.config/rofi/smplos-launcher.rasi"
CENTER_STR='window { location: center; anchor: center; width: 560px; }'
rofi_args=(-dmenu -i -p "Keys" -matching fuzzy -sorting-method fzf -normal-window -steal-focus)
rofi_args+=(-mesg "Super+K  Keybindings  --  type to filter")
[[ -f "$ROFI_THEME" ]] && rofi_args+=(-theme "$ROFI_THEME" -theme-str "$CENTER_STR")

rofi "${rofi_args[@]}" < "$CACHE" >/dev/null 2>&1
