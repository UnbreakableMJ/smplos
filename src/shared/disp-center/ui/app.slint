// Display Center - custom themed UI (no std-widgets)
// Matches notif-center / kb-center visual style

// Theme globals - set from Rust at runtime via EWW SCSS, defaults are Catppuccin Mocha
export global Theme {
    in-out property <color> bg: #1e1e2e;
    in-out property <color> fg: #cdd6f4;
    in-out property <color> fg_dim: #a6adc8;
    in-out property <color> accent: #89b4fa;
    in-out property <color> bg_light: #45475a;
    in-out property <color> bg_lighter: #585b70;
    in-out property <color> red: #f38ba8;
    in-out property <color> green: #a6e3a1;
    in-out property <color> yellow: #f9e2af;
    in-out property <color> cyan: #94e2d5;
    in-out property <float> opacity: 0.40;
}

// Data model passed from Rust
struct MonitorInfo {
    id: int,
    name: string,
    description: string,
    width: int,
    height: int,
    refresh-rate: float,
    pos-x: int,
    pos-y: int,
    scale: float,
    enabled: bool,
    is-primary: bool,
    canvas-x: float,
    canvas-y: float,
    canvas-w: float,
    canvas-h: float,
    available-modes: [string],
    current-mode-index: int,
}

// -- Custom dropdown (resolution picker) --
component Dropdown inherits Rectangle {
    in property <[string]> model: [];
    in-out property <int> current-index: 0;
    in-out property <bool> open: false;
    callback selected(int);

    height: 28px;
    border-radius: 4px;
    background: Theme.bg_light;

    HorizontalLayout {
        padding-left: 8px;
        padding-right: 8px;

        Text {
            text: model.length > 0 && current-index >= 0 && current-index < model.length
                ? model[current-index] : "---";
            color: Theme.fg;
            font-size: 11px;
            vertical-alignment: center;
            horizontal-stretch: 1;
            overflow: elide;
        }

        Text {
            text: root.open ? "\u{25b2}" : "\u{25bc}";
            color: Theme.fg_dim;
            font-size: 8px;
            vertical-alignment: center;
            width: 16px;
            horizontal-alignment: center;
        }
    }

    drop-touch := TouchArea {
        clicked => {
            root.open = !root.open;
        }
    }

    if root.open: Rectangle {
        x: 0;
        y: parent.height + 2px;
        width: parent.width;
        height: min(200px, root.model.length * 26px + 4px);
        border-radius: 4px;
        background: Theme.bg_light;
        border-width: 1px;
        border-color: Theme.bg_lighter;
        drop-shadow-blur: 8px;
        drop-shadow-color: #00000066;

        Flickable {
            x: 2px;
            y: 2px;
            width: parent.width - 4px;
            height: parent.height - 4px;
            viewport-width: self.width;

            VerticalLayout {
                spacing: 0;
                for item[idx] in root.model: Rectangle {
                    height: 26px;
                    border-radius: 3px;
                    background: idx == root.current-index ? Theme.accent
                              : opt-touch.has-hover ? Theme.bg_lighter
                              : transparent;

                    Text {
                        text: item;
                        color: idx == root.current-index ? Theme.bg : Theme.fg;
                        font-size: 11px;
                        vertical-alignment: center;
                        x: 6px;
                    }

                    opt-touch := TouchArea {
                        clicked => {
                            root.current-index = idx;
                            root.open = false;
                            root.selected(idx);
                        }
                    }
                }
            }
        }
    }
}

// -- Custom slider (scale control) --
component ThemeSlider inherits Rectangle {
    in-out property <float> value: 1.0;
    in property <float> minimum: 0.5;
    in property <float> maximum: 3.0;
    callback changed(float);

    height: 20px;

    // Track
    Rectangle {
        y: (parent.height - 4px) / 2;
        height: 4px;
        border-radius: 2px;
        background: Theme.bg_lighter;

        // Filled portion
        Rectangle {
            width: parent.width * ((root.value - root.minimum) / (root.maximum - root.minimum));
            height: parent.height;
            border-radius: parent.border-radius;
            background: Theme.accent;
        }
    }

    // Thumb
    Rectangle {
        x: (parent.width - 14px) * ((root.value - root.minimum) / (root.maximum - root.minimum));
        y: (parent.height - 14px) / 2;
        width: 14px;
        height: 14px;
        border-radius: 7px;
        background: slider-touch.pressed ? Theme.accent.darker(0.2) : Theme.accent;
        drop-shadow-blur: 3px;
        drop-shadow-color: #00000044;
    }

    slider-touch := TouchArea {
        moved => {
            if (self.pressed) {
                root.value = clamp(root.minimum + (self.mouse-x / root.width) * (root.maximum - root.minimum), root.minimum, root.maximum);
                root.value = round(root.value * 4) / 4;
                root.changed(root.value);
            }
        }
        pointer-event(event) => {
            if (event.kind == PointerEventKind.down) {
                root.value = clamp(root.minimum + (self.mouse-x / root.width) * (root.maximum - root.minimum), root.minimum, root.maximum);
                root.value = round(root.value * 4) / 4;
                root.changed(root.value);
            }
        }
    }
}

// -- Draggable monitor rectangle in the canvas --
component MonitorRect inherits Rectangle {
    in property <string> label;
    in property <string> sublabel;
    in property <bool> selected;
    in property <bool> is-primary;

    in property <float> base-x;
    in property <float> base-y;
    in-out property <float> offset-x: 0;
    in-out property <float> offset-y: 0;
    private property <bool> dragging: false;

    callback clicked();
    callback drag-finished(float, float);

    x: (base-x + offset-x) * 1px;
    y: (base-y + offset-y) * 1px;

    border-radius: 6px;
    border-width: selected ? 2px : 1px;
    border-color: selected ? Theme.accent : Theme.bg_lighter;
    background: dragging ? Theme.bg_lighter
              : selected ? Theme.bg_light
              : Theme.bg_light.darker(0.3);
    drop-shadow-blur: dragging ? 12px : selected ? 8px : 2px;
    drop-shadow-color: #00000066;

    VerticalLayout {
        alignment: center;
        padding: 8px;

        Text {
            text: label;
            color: Theme.fg;
            font-size: 14px;
            font-weight: 700;
            horizontal-alignment: center;
        }

        Text {
            text: sublabel;
            color: Theme.fg_dim;
            font-size: 10px;
            horizontal-alignment: center;
        }

        if is-primary: Text {
            text: "Primary";
            color: Theme.accent;
            font-size: 9px;
            font-weight: 600;
            horizontal-alignment: center;
        }
    }

    touch := TouchArea {
        mouse-cursor: root.dragging ? pointer : default;

        clicked => {
            if (!root.dragging) {
                root.clicked();
            }
        }

        moved => {
            if (self.pressed) {
                root.dragging = true;
                root.offset-x += (self.mouse-x - self.pressed-x) / 1px;
                root.offset-y += (self.mouse-y - self.pressed-y) / 1px;
            }
        }

        pointer-event(event) => {
            if (event.kind == PointerEventKind.up) {
                if (root.dragging) {
                    root.drag-finished(root.base-x + root.offset-x,
                                       root.base-y + root.offset-y);
                }
                root.dragging = false;
                root.offset-x = 0;
                root.offset-y = 0;
            }
        }
    }
}

// ============================================================
// Main application window
// ============================================================
export component App inherits Window {
    title: "Display Center";
    width: 680px;
    height: 520px;
    no-frame: true;
    background: Theme.bg.transparentize(1.0 - Theme.opacity);
    forward-focus: key-scope;

    in property <[MonitorInfo]> monitors: [];
    in-out property <int> selected-index: -1;
    in property <[string]> selected-modes: [];
    in-out property <int> selected-mode-index: 0;
    in-out property <float> selected-scale: 1.0;
    in property <string> status-text: "Ready";
    in property <bool> has-changes: false;

    callback select-monitor(int);
    callback drag-finished(int, float, float);
    callback change-resolution(int, int);
    callback change-scale(int, float);
    callback set-primary(int);
    callback apply-changes();
    callback revert-changes();
    callback refresh-monitors();
    callback identify-monitors();
    callback close();
    callback move-window(length, length);

    // Keyboard accelerators
    key-scope := FocusScope {
        key-pressed(event) => {
            if (event.text == Key.Escape) {
                root.close();
                return accept;
            }
            if (event.modifiers.alt) {
                if (event.text == "i") {
                    root.identify-monitors();
                    return accept;
                }
                if (event.text == "r") {
                    root.refresh-monitors();
                    return accept;
                }
                if (event.text == "p" && root.selected-index >= 0 && root.selected-index < root.monitors.length && !monitors[root.selected-index].is-primary) {
                    root.set-primary(root.selected-index);
                    return accept;
                }
                if (event.text == "a" && root.has-changes) {
                    root.apply-changes();
                    return accept;
                }
                if (event.text == "v" && root.has-changes) {
                    root.revert-changes();
                    return accept;
                }
            }
            return reject;
        }

        // Outer border (matches notif-center pattern)
        Rectangle {
            border-radius: 0px;
            border-width: 1px;
            border-color: Theme.bg_lighter;
            background: transparent;

            // Inner content area
            Rectangle {
                x: 6px;
                y: 1px;
                width: parent.width - 12px;
                height: parent.height - 2px;
                background: transparent;

                VerticalLayout {
                    padding: 10px;
                    spacing: 8px;

                    // ---- Header (draggable title bar) ----
                    Rectangle {
                        height: 34px;
                        background: transparent;

                        HorizontalLayout {
                            spacing: 8px;

                            // Title
                            VerticalLayout {
                                alignment: center;
                                horizontal-stretch: 0;
                                Text {
                                    text: "Display Settings";
                                    color: Theme.fg;
                                    font-size: 15px;
                                    font-weight: 700;
                                    vertical-alignment: center;
                                }
                            }

                            // Draggable spacer
                            Rectangle {
                                horizontal-stretch: 1;
                                background: transparent;
                                drag-area := TouchArea {
                                    pointer-event(event) => {
                                        if (event.kind == PointerEventKind.down) {
                                            root.move-window(0px, 0px);
                                        }
                                    }
                                    moved => {
                                        if (self.pressed) {
                                            root.move-window(
                                                self.mouse-x - self.pressed-x,
                                                self.mouse-y - self.pressed-y
                                            );
                                        }
                                    }
                                    mouse-cursor: move;
                                }
                            }

                            // Identify button with underlined I
                            VerticalLayout {
                                alignment: center;
                                Rectangle {
                                    height: 26px;
                                    min-width: identify-layout.preferred-width + 20px;
                                    border-radius: 4px;
                                    background: identify-touch.has-hover ? Theme.accent : Theme.bg_light;

                                    identify-layout := HorizontalLayout {
                                        alignment: center;
                                        padding-left: 10px;
                                        padding-right: 10px;

                                        // "I" with underline
                                        Rectangle {
                                            width: 6px;
                                            height: parent.height;
                                            Text {
                                                text: "I";
                                                color: identify-touch.has-hover ? Theme.bg : Theme.fg;
                                                font-size: 12px;
                                                vertical-alignment: center;
                                                horizontal-alignment: center;
                                                width: parent.width;
                                                height: parent.height;
                                            }
                                            Rectangle {
                                                x: 0px;
                                                y: parent.height / 2 + 7px;
                                                width: parent.width;
                                                height: 1px;
                                                background: identify-touch.has-hover ? Theme.bg : Theme.fg;
                                            }
                                        }
                                        Text {
                                            text: "dentify";
                                            color: identify-touch.has-hover ? Theme.bg : Theme.fg;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                        }
                                    }

                                    identify-touch := TouchArea {
                                        clicked => { root.identify-monitors(); }
                                        mouse-cursor: pointer;
                                    }
                                }
                            }

                            // Refresh button with underlined R
                            VerticalLayout {
                                alignment: center;
                                Rectangle {
                                    height: 26px;
                                    min-width: refresh-layout.preferred-width + 20px;
                                    border-radius: 4px;
                                    background: refresh-touch.has-hover ? Theme.accent : Theme.bg_light;

                                    refresh-layout := HorizontalLayout {
                                        alignment: center;
                                        padding-left: 10px;
                                        padding-right: 10px;

                                        // "R" with underline
                                        Rectangle {
                                            width: 9px;
                                            height: parent.height;
                                            Text {
                                                text: "R";
                                                color: refresh-touch.has-hover ? Theme.bg : Theme.fg;
                                                font-size: 12px;
                                                vertical-alignment: center;
                                                horizontal-alignment: center;
                                                width: parent.width;
                                                height: parent.height;
                                            }
                                            Rectangle {
                                                x: 1px;
                                                y: parent.height / 2 + 7px;
                                                width: 7px;
                                                height: 1px;
                                                background: refresh-touch.has-hover ? Theme.bg : Theme.fg;
                                            }
                                        }
                                        Text {
                                            text: "efresh";
                                            color: refresh-touch.has-hover ? Theme.bg : Theme.fg;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                        }
                                    }

                                    refresh-touch := TouchArea {
                                        clicked => { root.refresh-monitors(); }
                                        mouse-cursor: pointer;
                                    }
                                }
                            }

                            // Close button
                            VerticalLayout {
                                alignment: center;
                                Rectangle {
                                    width: 26px;
                                    height: 26px;
                                    border-radius: 4px;
                                    background: close-touch.has-hover ? Theme.red : Theme.bg_light;

                                    Text {
                                        text: "\u{2715}";
                                        color: close-touch.has-hover ? Theme.bg : Theme.fg;
                                        font-size: 12px;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }

                                    close-touch := TouchArea {
                                        clicked => { root.close(); }
                                        mouse-cursor: pointer;
                                    }
                                }
                            }
                        }
                    }

                    // ---- Canvas area: monitor rectangles ----
                    canvas-area := Rectangle {
                        background: Theme.bg.darker(0.3);
                        border-radius: 6px;
                        border-width: 1px;
                        border-color: Theme.bg_lighter;
                        min-height: 220px;
                        vertical-stretch: 1;

                        if monitors.length == 0: Text {
                            text: "No monitors detected";
                            color: Theme.fg_dim;
                            font-size: 14px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }

                        for mon[i] in monitors: MonitorRect {
                            width: mon.canvas-w * 1px;
                            height: mon.canvas-h * 1px;
                            base-x: mon.canvas-x;
                            base-y: mon.canvas-y;
                            label: mon.name;
                            sublabel: "\{mon.width}x\{mon.height}";
                            selected: i == selected-index;
                            is-primary: mon.is-primary;

                            clicked => {
                                root.selected-index = i;
                                root.select-monitor(i);
                            }

                            drag-finished(cx, cy) => {
                                root.selected-index = i;
                                root.drag-finished(i, cx, cy);
                            }
                        }
                    }

                    // ---- Settings panel for selected monitor ----
                    if selected-index >= 0 && selected-index < monitors.length: Rectangle {
                        background: Theme.bg_light;
                        border-radius: 6px;
                        height: 82px;

                        VerticalLayout {
                            padding: 10px;
                            spacing: 6px;

                            // Monitor name + description
                            Text {
                                text: "Monitor: " + monitors[root.selected-index].name + "  -  " + monitors[root.selected-index].description;
                                color: Theme.fg_dim;
                                font-size: 10px;
                                overflow: elide;
                            }

                            HorizontalLayout {
                                spacing: 12px;

                                // Resolution dropdown
                                VerticalLayout {
                                    spacing: 3px;
                                    min-width: 180px;
                                    Text { text: "Resolution"; color: Theme.fg_dim; font-size: 10px; }
                                    Dropdown {
                                        model: root.selected-modes;
                                        current-index: root.selected-mode-index;
                                        selected(idx) => {
                                            root.change-resolution(root.selected-index, idx);
                                        }
                                    }
                                }

                                // Scale slider
                                VerticalLayout {
                                    spacing: 3px;
                                    horizontal-stretch: 1;
                                    Text {
                                        text: "Scale: " + round(root.selected-scale * 100) / 100;
                                        color: Theme.fg_dim;
                                        font-size: 10px;
                                    }
                                    ThemeSlider {
                                        value: root.selected-scale;
                                        minimum: 0.5;
                                        maximum: 3.0;
                                        changed(v) => {
                                            root.change-scale(root.selected-index, v);
                                        }
                                    }
                                }

                                // Set Primary button with underlined P
                                VerticalLayout {
                                    spacing: 3px;
                                    alignment: end;
                                    Text { text: " "; font-size: 10px; }
                                    Rectangle {
                                        height: 26px;
                                        min-width: primary-layout.preferred-width + 20px;
                                        border-radius: 4px;
                                        background: monitors[root.selected-index].is-primary
                                            ? Theme.bg_light.darker(0.2)
                                            : primary-touch.has-hover ? Theme.accent : Theme.bg_lighter;

                                        primary-layout := HorizontalLayout {
                                            alignment: center;
                                            padding-left: 10px;
                                            padding-right: 10px;

                                            if !monitors[root.selected-index].is-primary: Text {
                                                text: "Set ";
                                                color: primary-touch.has-hover ? Theme.bg : Theme.fg;
                                                font-size: 12px;
                                                vertical-alignment: center;
                                            }

                                            // "P" with underline
                                            Rectangle {
                                                width: 10px;
                                                height: parent.height;
                                                Text {
                                                    text: "P";
                                                    color: monitors[root.selected-index].is-primary
                                                        ? Theme.fg_dim.darker(0.3)
                                                        : primary-touch.has-hover ? Theme.bg : Theme.fg;
                                                    font-size: 12px;
                                                    vertical-alignment: center;
                                                    horizontal-alignment: center;
                                                    width: parent.width;
                                                    height: parent.height;
                                                }
                                                Rectangle {
                                                    x: 1px;
                                                    y: parent.height / 2 + 7px;
                                                    width: 8px;
                                                    height: 1px;
                                                    background: monitors[root.selected-index].is-primary
                                                        ? Theme.fg_dim.darker(0.3)
                                                        : primary-touch.has-hover ? Theme.bg : Theme.fg;
                                                }
                                            }

                                            Text {
                                                text: "rimary";
                                                color: monitors[root.selected-index].is-primary
                                                    ? Theme.fg_dim.darker(0.3)
                                                    : primary-touch.has-hover ? Theme.bg : Theme.fg;
                                                font-size: 12px;
                                                vertical-alignment: center;
                                            }
                                        }

                                        primary-touch := TouchArea {
                                            enabled: !monitors[root.selected-index].is-primary;
                                            mouse-cursor: monitors[root.selected-index].is-primary ? default : pointer;
                                            clicked => {
                                                root.set-primary(root.selected-index);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    // ---- Footer: status + action buttons ----
                    HorizontalLayout {
                        height: 28px;
                        spacing: 8px;

                        Text {
                            text: root.status-text;
                            color: Theme.fg_dim;
                            font-size: 10px;
                            vertical-alignment: center;
                            horizontal-stretch: 1;
                            overflow: elide;
                        }

                        // Revert button with underlined v
                        VerticalLayout {
                            alignment: center;
                            Rectangle {
                                height: 26px;
                                min-width: revert-layout.preferred-width + 20px;
                                border-radius: 4px;
                                background: !root.has-changes
                                    ? Theme.bg_light.darker(0.2)
                                    : revert-touch.has-hover ? Theme.yellow : Theme.bg_light;

                                revert-layout := HorizontalLayout {
                                    alignment: center;
                                    padding-left: 10px;
                                    padding-right: 10px;

                                    Text {
                                        text: "Re";
                                        color: !root.has-changes ? Theme.fg_dim.darker(0.3)
                                            : revert-touch.has-hover ? Theme.bg : Theme.fg;
                                        font-size: 12px;
                                        vertical-alignment: center;
                                    }

                                    // "v" with underline
                                    Rectangle {
                                        width: 8px;
                                        height: parent.height;
                                        Text {
                                            text: "v";
                                            color: !root.has-changes ? Theme.fg_dim.darker(0.3)
                                                : revert-touch.has-hover ? Theme.bg : Theme.fg;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                            horizontal-alignment: center;
                                            width: parent.width;
                                            height: parent.height;
                                        }
                                        Rectangle {
                                            x: 0px;
                                            y: parent.height / 2 + 7px;
                                            width: parent.width;
                                            height: 1px;
                                            background: !root.has-changes ? Theme.fg_dim.darker(0.3)
                                                : revert-touch.has-hover ? Theme.bg : Theme.fg;
                                        }
                                    }

                                    Text {
                                        text: "ert";
                                        color: !root.has-changes ? Theme.fg_dim.darker(0.3)
                                            : revert-touch.has-hover ? Theme.bg : Theme.fg;
                                        font-size: 12px;
                                        vertical-alignment: center;
                                    }
                                }

                                revert-touch := TouchArea {
                                    enabled: root.has-changes;
                                    mouse-cursor: root.has-changes ? pointer : default;
                                    clicked => { root.revert-changes(); }
                                }
                            }
                        }

                        // Apply button with underlined A
                        VerticalLayout {
                            alignment: center;
                            Rectangle {
                                height: 26px;
                                min-width: apply-layout.preferred-width + 20px;
                                border-radius: 4px;
                                background: !root.has-changes
                                    ? Theme.bg_light.darker(0.2)
                                    : apply-touch.has-hover ? Theme.green : Theme.bg_light;

                                apply-layout := HorizontalLayout {
                                    alignment: center;
                                    padding-left: 10px;
                                    padding-right: 10px;

                                    // "A" with underline
                                    Rectangle {
                                        width: 9px;
                                        height: parent.height;
                                        Text {
                                            text: "A";
                                            color: !root.has-changes ? Theme.fg_dim.darker(0.3)
                                                : apply-touch.has-hover ? Theme.bg : Theme.fg;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                            horizontal-alignment: center;
                                            width: parent.width;
                                            height: parent.height;
                                        }
                                        Rectangle {
                                            x: 1px;
                                            y: parent.height / 2 + 7px;
                                            width: 7px;
                                            height: 1px;
                                            background: !root.has-changes ? Theme.fg_dim.darker(0.3)
                                                : apply-touch.has-hover ? Theme.bg : Theme.fg;
                                        }
                                    }

                                    Text {
                                        text: "pply";
                                        color: !root.has-changes ? Theme.fg_dim.darker(0.3)
                                            : apply-touch.has-hover ? Theme.bg : Theme.fg;
                                        font-size: 12px;
                                        vertical-alignment: center;
                                    }
                                }

                                apply-touch := TouchArea {
                                    enabled: root.has-changes;
                                    mouse-cursor: root.has-changes ? pointer : default;
                                    clicked => { root.apply-changes(); }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
