struct NotificationItem {
    id: int,
    icon: string,
    summary: string,
    body: string,
    date: string,
    time: string,
}

export global Theme {
    in-out property <color> bg: #1e1e2e;
    in-out property <color> fg: #cdd6f4;
    in-out property <color> fg_dim: #a6adc8;
    in-out property <color> accent: #89b4fa;
    in-out property <color> bg_light: #45475a;
    in-out property <color> bg_lighter: #585b70;
    in-out property <color> red: #f38ba8;
    in-out property <color> green: #a6e3a1;
    in-out property <color> yellow: #f9e2af;
    in-out property <color> cyan: #94e2d5;
    in-out property <float> opacity: 0.40;
    in-out property <length> card_radius: 6px;
    in-out property <length> button_radius: 4px;
}

export component MainWindow inherits Window {
    width: 384px;
    height: 520px;
    title: "Notifications";
    no-frame: true;
    background: Theme.bg;
    forward-focus: key_scope;

    in-out property <[NotificationItem]> notifications: [];
    in-out property <int> selected-index: -1;
    in-out property <string> notif-count-text: "";
    private property <length> row-height: 45px;
    private property <length> row-spacing: 8px;
    private property <length> row-step: root.row-height + root.row-spacing;

    callback refresh();
    callback dismiss(int);
    callback clear-all();
    callback activate(int);
    callback close();

    public function focus-list() {
        key_scope.focus();
    }

    function min-viewport-y() -> length {
        return min(0px, list_flick.height - list_flick.viewport-height);
    }

    function clamp-viewport() {
        if (list_flick.viewport-y > 0px) {
            list_flick.viewport-y = 0px;
        }
        if (list_flick.viewport-y < root.min-viewport-y()) {
            list_flick.viewport-y = root.min-viewport-y();
        }
    }

    function scroll-by(delta: length) {
        list_flick.viewport-y += delta;
        root.clamp-viewport();
    }

    function ensure-selected-visible() {
        if (root.selected-index < 0 || root.selected-index >= root.notifications.length) {
            return;
        }

        // Approximate scroll position using row-step (works for most rows)
        if (list_flick.viewport-y + root.selected-index * root.row-step < 0px) {
            list_flick.viewport-y = 0px - root.selected-index * root.row-step;
        }

        if (list_flick.viewport-y + root.selected-index * root.row-step + root.row-height > list_flick.height) {
            list_flick.viewport-y = list_flick.height - root.selected-index * root.row-step - root.row-height;
        }

        root.clamp-viewport();
    }

    changed selected-index => {
        root.ensure-selected-visible();
    }

    changed notifications => {
        if (root.notifications.length == 0) {
            root.selected-index = -1;
            list_flick.viewport-y = 0px;
        } else if (root.selected-index < 0) {
            root.selected-index = 0;
        }
        root.clamp-viewport();
        root.ensure-selected-visible();
    }

    changed visible => {
        if (root.visible) {
            key_scope.focus();
            root.ensure-selected-visible();
        }
    }

    key_scope := FocusScope {
        key-pressed(event) => {
            if (event.text == Key.UpArrow) {
                if (root.notifications.length > 0) {
                    if (root.selected-index <= 0) {
                        root.selected-index = 0;
                    } else {
                        root.selected-index -= 1;
                    }
                }
                return accept;
            }

            if (event.text == Key.DownArrow) {
                if (root.notifications.length > 0) {
                    if (root.selected-index < 0) {
                        root.selected-index = 0;
                    } else if (root.selected-index < root.notifications.length - 1) {
                        root.selected-index += 1;
                    }
                }
                return accept;
            }

            if (event.text == Key.Return) {
                if (root.selected-index >= 0 && root.selected-index < root.notifications.length) {
                    root.activate(root.notifications[root.selected-index].id);
                }
                return accept;
            }

            if (event.text == Key.Delete) {
                if (root.selected-index >= 0 && root.selected-index < root.notifications.length) {
                    root.dismiss(root.notifications[root.selected-index].id);
                }
                return accept;
            }

            if (event.text == Key.Escape) {
                root.close();
                return accept;
            }

            if (event.modifiers.alt && (event.text == "a" || event.text == "A")) {
                root.clear-all();
                return accept;
            }

            return reject;
        }

        Rectangle {
            border-radius: 0px;
            border-width: 1px;
            border-color: Theme.bg_lighter;
            background: Theme.bg;

            Rectangle {
                x: 6px;
                y: 1px;
                width: parent.width - 12px;
                height: parent.height - 2px;
                border-radius: 0px;
                background: Theme.bg;

            VerticalLayout {
                padding: 4px;
                spacing: 3px;

                Rectangle {
                    height: 38px;
                    background: transparent;
                    HorizontalLayout {
                        padding-right: 14px;
                        spacing: 8px;
                        VerticalLayout {
                             alignment: center;
                             Text {
                                text: root.notif-count-text;
                                color: Theme.fg;
                                font-weight: 700;
                                font-size: 15px;
                                vertical-alignment: center;
                             }
                        }
                        Rectangle { horizontal-stretch: 1; background: transparent; }
                        VerticalLayout {
                             alignment: center;
                             Rectangle {
                                visible: root.notifications.length > 0;
                                border-radius: Theme.button_radius;
                                background: clear_touch.has-hover ? Theme.red : Theme.bg_light;
                                min-width: 78px;
                                height: 26px;
                                HorizontalLayout {
                                    alignment: center;
                                    padding-top: 1px;
                                    Text {
                                        text: "Clear ";
                                        color: clear_touch.has-hover ? Theme.bg : Theme.fg;
                                        vertical-alignment: center;
                                    }
                                    Rectangle {
                                        width: 9px;
                                        VerticalLayout {
                                            alignment: center;
                                            Text {
                                                text: "A";
                                                color: clear_touch.has-hover ? Theme.bg : Theme.fg;
                                                vertical-alignment: center;
                                            }
                                            Rectangle {
                                                height: 1px;
                                                background: clear_touch.has-hover ? Theme.bg : Theme.fg;
                                            }
                                        }
                                    }
                                    Text {
                                        text: "ll";
                                        color: clear_touch.has-hover ? Theme.bg : Theme.fg;
                                        vertical-alignment: center;
                                    }
                                }
                                clear_touch := TouchArea {
                                    clicked => {
                                        key_scope.focus();
                                        root.clear-all();
                                    }
                                }
                            }
                        }
                        VerticalLayout {
                             alignment: center;
                             Rectangle {
                                border-radius: Theme.button_radius;
                                background: close_touch.has-hover ? Theme.red : Theme.bg_light;
                                width: 26px;
                                height: 26px;
                                Text {
                                    text: "✕";
                                    color: close_touch.has-hover ? Theme.bg : Theme.fg;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                                close_touch := TouchArea {
                                    clicked => {
                                        key_scope.focus();
                                        root.close();
                                    }
                                }
                            }
                        }
                    }
                }

                Rectangle {
                    vertical-stretch: 1;
                    background: transparent;

                    viewport := Rectangle {
                        x: 0px;
                        y: 0px;
                        width: parent.width;
                        height: parent.height;
                        clip: true;

                        list_flick := Flickable {
                            x: 0px;
                            y: 0px;
                            width: parent.width - 14px;
                            height: parent.height;
                            viewport-width: self.width;
                            interactive: true;

                            VerticalLayout {
                                alignment: start;
                                spacing: root.row-spacing;

                                for n[index] in root.notifications: Rectangle {
                                    border-radius: Theme.card_radius;
                                    border-width: 0px;
                                    background: root.selected-index == index
                                        ? Theme.bg_lighter
                                        : (row_touch.has-hover ? Theme.bg_lighter : Theme.bg_light);

                                    row_touch := TouchArea {
                                        clicked => {
                                            key_scope.focus();
                                            root.selected-index = index;
                                        }
                                        double-clicked => {
                                            key_scope.focus();
                                            root.selected-index = index;
                                            root.activate(n.id);
                                        }
                                        scroll-event(event) => {
                                            root.scroll-by(event.delta-y);
                                            return accept;
                                        }
                                    }

                                    HorizontalLayout {
                                        padding-left: 8px;
                                        padding-right: 4px;
                                        padding-top: 4px;
                                        padding-bottom: 4px;
                                        spacing: 4px;

                                        // Icon
                                        VerticalLayout {
                                            alignment: start;
                                            padding-top: 2px;
                                            Text {
                                                width: 26px;
                                                text: n.icon == "" ? "󰂚" : n.icon;
                                                color: Theme.accent;
                                                font-size: 20px;
                                                horizontal-alignment: center;
                                            }
                                        }

                                        // Summary + body
                                        VerticalLayout {
                                            horizontal-stretch: 1;
                                            spacing: 1px;
                                            alignment: start;
                                            padding-top: 2px;
                                            Text {
                                                text: n.summary;
                                                color: Theme.fg;
                                                font-weight: 700;
                                                font-size: 13px;
                                                overflow: elide;
                                            }
                                            if n.body != "": Text {
                                                text: n.body;
                                                color: Theme.fg_dim;
                                                font-size: 11px;
                                                wrap: word-wrap;
                                            }
                                        }

                                        // Date/time
                                        VerticalLayout {
                                            alignment: start;
                                            padding-top: 1px;
                                            spacing: 0px;
                                            Text {
                                                text: n.date;
                                                color: Theme.fg_dim;
                                                font-size: 9px;
                                                horizontal-alignment: right;
                                            }
                                            Text {
                                                text: n.time;
                                                color: Theme.fg_dim;
                                                font-size: 10px;
                                                horizontal-alignment: right;
                                            }
                                        }

                                        // Dismiss button
                                        VerticalLayout {
                                            alignment: start;
                                            padding-top: 2px;
                                            Rectangle {
                                                border-radius: Theme.button_radius;
                                                background: dismiss_touch.has-hover ? Theme.red : transparent;
                                                width: 24px;
                                                height: 24px;
                                                opacity: row_touch.has-hover || dismiss_touch.has-hover ? 1.0 : 0.4;
                                                Text {
                                                    text: "✕";
                                                    color: dismiss_touch.has-hover ? Theme.bg : Theme.fg_dim;
                                                    font-size: 15px;
                                                    horizontal-alignment: center;
                                                    vertical-alignment: center;
                                                }
                                                dismiss_touch := TouchArea {
                                                    clicked => {
                                                        key_scope.focus();
                                                        root.dismiss(n.id);
                                                    }
                                                    scroll-event(event) => {
                                                        root.scroll-by(event.delta-y);
                                                        return accept;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        Rectangle {
                            visible: list_flick.viewport-height > list_flick.height;
                            x: parent.width - 6px;
                            y: 0px;
                            width: 6px;
                            height: parent.height;
                            background: Theme.bg_light;

                            Rectangle {
                                width: parent.width;
                                height: max(24px, parent.height * parent.height / list_flick.viewport-height);
                                y: list_flick.viewport-height > list_flick.height
                                    ? (-list_flick.viewport-y / (list_flick.viewport-height - list_flick.height)) * (parent.height - self.height)
                                    : 0px;
                                background: Theme.bg_lighter;
                                opacity: 0.5;
                            }
                        }
                    }

                    if (root.notifications.length == 0): Rectangle {
                        x: 0px;
                        y: 0px;
                        width: parent.width;
                        height: parent.height;
                        background: transparent;
                        HorizontalLayout {
                            alignment: center;
                            Rectangle { background: transparent; horizontal-stretch: 1; }
                            VerticalLayout {
                                alignment: center;
                                spacing: 8px;
                                Text {
                                    text: "󰂜";
                                    color: Theme.accent;
                                    font-size: 34px;
                                    horizontal-alignment: center;
                                }
                                Text {
                                    text: "No notifications";
                                    color: Theme.fg;
                                    horizontal-alignment: center;
                                }
                            }
                            Rectangle { background: transparent; horizontal-stretch: 1; }
                        }
                    }
                }
            }
        }
    }
}
}
