#!/bin/bash
# Boot smplOS ISO in QEMU with correct boot priorities
# Hard drive has priority over CD-ROM, so after installation
# the system will boot from the installed OS, not the ISO

set -e

ISO="$1"
REUSE="$2"

# Find ISO if not provided
if [ $# -eq 0 ]; then
  if command -v gum &>/dev/null; then
    ISO=$(ls -t release/*.iso 2>/dev/null | gum choose --header "Select ISO to boot")
    if gum confirm --default=false "Reuse existing disk?"; then
      REUSE="reuse"
    fi
  else
    ISO=$(ls -t release/*.iso 2>/dev/null | head -1)
  fi
fi

if [ -z "$ISO" ]; then
  echo "Usage: smplos-qemu-boot [release/smplos.iso] [reuse]"
  echo ""
  echo "Options:"
  echo "  reuse    - Reuse existing virtual disk (don't recreate)"
  echo ""
  echo "SSH available at: ssh -p 2222 root@localhost (after installing openssh)"
  exit 1
fi

# Check for required packages
if ! command -v qemu-system-x86_64 &>/dev/null; then
  echo "Please install qemu-full: sudo pacman -S qemu-full edk2-ovmf"
  exit 1
fi

if [ ! -f /usr/share/edk2/x64/OVMF_CODE.4m.fd ]; then
  echo "Please install edk2-ovmf: sudo pacman -S edk2-ovmf"
  exit 1
fi

DISK="/tmp/smplos-qemu-boot.qcow2"
OVMF_VARS="/tmp/smplos-OVMF_VARS.4m.fd"

if [[ ! -f $DISK || $REUSE != "reuse" ]]; then
  echo "Creating new virtual disk..."
  qemu-img create -f qcow2 "$DISK" 20G
  cp /usr/share/edk2/x64/OVMF_VARS.4m.fd "$OVMF_VARS"
fi

echo "Booting: $ISO"
echo ""
echo "Boot priority: Hard drive (1) > CD-ROM (2)"
echo "After installation, system will boot from installed OS."

# Boot with hard drive having higher priority than CD-ROM
# This ensures that after installation, the system boots from the installed OS
qemu-system-x86_64 \
  -cpu host -enable-kvm -machine q35,accel=kvm \
  -smp "$(nproc)" \
  -m 8192 \
  -drive if=pflash,format=raw,readonly=on,file=/usr/share/edk2/x64/OVMF_CODE.4m.fd \
  -drive if=pflash,format=raw,file="$OVMF_VARS" \
  -drive file="$DISK",format=qcow2,if=none,id=drive0 \
  -device virtio-blk-pci,drive=drive0,bootindex=1 \
  -drive file="$ISO",media=cdrom,if=none,format=raw,id=cdrom0 \
  -device ide-cd,drive=cdrom0,bootindex=2 \
  -device virtio-vga-gl \
  -display gtk,gl=on \
  -usb -device usb-tablet \
  -netdev user,id=net0,hostfwd=tcp::2222-:22 \
  -device virtio-net-pci,netdev=net0 \
  -boot menu=on
